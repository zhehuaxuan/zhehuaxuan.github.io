<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="知足.感恩.幸运">
<meta property="og:type" content="website">
<meta property="og:title" content="zhehua&#39;s note">
<meta property="og:url" content="https://zhehuaxuan.github.io/index.html">
<meta property="og:site_name" content="zhehua&#39;s note">
<meta property="og:description" content="知足.感恩.幸运">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="zhehua&#39;s note">
<meta name="twitter:description" content="知足.感恩.幸运">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.3',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://zhehuaxuan.github.io/"/>





  <title>zhehua's note</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">zhehua's note</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            时光
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-works">
          <a href="/works/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />
            
            作品
          </a>
        </li>
      
        
        <li class="menu-item menu-item-nav">
          <a href="/nav/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-send"></i> <br />
            
            站点
          </a>
        </li>
      
        
        <li class="menu-item menu-item-think">
          <a href="/think/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-grav"></i> <br />
            
            随想
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhehuaxuan.github.io/2019/03/07/跟underscore一起学如何写函数库/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZheHuaXuan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhehua's note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/07/跟underscore一起学如何写函数库/" itemprop="url">跟underscore一起学如何写函数库</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-07T22:49:38+08:00">
                2019-03-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/underscore/" itemprop="url" rel="index">
                    <span itemprop="name">underscore</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p><a href="http://github.com/jashkenas/underscore/" target="_blank" rel="noopener">Underscore</a> 是一个 JavaScript 工具库，它提供了一整套函数式编程的实用功能，但是没有扩展任何 JavaScript 内置对象。</p>
<p>本文主要用于梳理和研究underscore内部是如何组织和处理函数的。</p>
<p>通过这篇文章，我们可以：</p>
<blockquote>
<p>了解underscore在函数组织方面的巧妙构思；</p>
<p>为自己书写函数库提供一定思路；</p>
</blockquote>
<p>我们开始！</p>
<h2 id="自己写个函数库"><a href="#自己写个函数库" class="headerlink" title="自己写个函数库"></a>自己写个函数库</h2><p>前端的小伙伴一定不会对jQuery陌生，经常使用<code>$.xxxx</code>的形式进行进行调用，underscore也使用<code>_.xxxx</code>，如果自己在ES5语法中写过自定义模块的话，就可以撸出下面一段代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">//定义</span></span><br><span class="line">    <span class="keyword">var</span> root = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> _ = &#123;&#125;;</span><br><span class="line">    _.first = <span class="function"><span class="keyword">function</span>(<span class="params">arr,n=<span class="number">0</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(n==<span class="number">0</span>) <span class="keyword">return</span> arr[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">return</span> arr.slice(<span class="number">0</span>,n);</span><br><span class="line">    &#125;</span><br><span class="line">    root._ = _;</span><br><span class="line">&#125;)();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">this</span>);</span><br></pre></td></tr></table></figure>
<p>在Chrome浏览器中打开之后，打印出如下结果：</p>
<p><img src="/2019/03/07/跟underscore一起学如何写函数库/image-20190305235718888.png" alt="image-20190305235718888"></p>
<p>我们看到在全局对象下有一个<code>_</code>属性，属性下面挂载了自定义函数，我们不妨使用<code>_.first(xxxx)</code>在全局环境下直接调用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(_.first([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]));</span><br><span class="line"><span class="built_in">console</span>.log(_.first([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>],<span class="number">1</span>));</span><br><span class="line"><span class="built_in">console</span>.log(_.first([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>],<span class="number">3</span>));</span><br></pre></td></tr></table></figure>
<p>输出结果如下：</p>
<p><img src="/2019/03/07/跟underscore一起学如何写函数库/image-20190306000334727.png" alt="image-20190306000334727"></p>
<p>没问题，我们的函数库制作完成了，我们一般直接这么用，也不会有太大问题。</p>
<h2 id="underscore是怎么做的？"><a href="#underscore是怎么做的？" class="headerlink" title="underscore是怎么做的？"></a>underscore是怎么做的？</h2><p>underscore正是基于上述代码的完善，那么underscore是如何接着往下做的呢？容我娓娓道来！</p>
<h3 id="对兼容性的考虑"><a href="#对兼容性的考虑" class="headerlink" title="对兼容性的考虑"></a>对兼容性的考虑</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Establish the root object, `window` (`self`) in the browser, `global`</span></span><br><span class="line"><span class="comment">// on the server, or `this` in some virtual machines. We use `self`</span></span><br><span class="line"><span class="comment">// instead of `window` for `WebWorker` support.</span></span><br><span class="line"><span class="keyword">var</span> root = <span class="keyword">typeof</span> self == <span class="string">'object'</span> &amp;&amp; self.self === self &amp;&amp; self ||</span><br><span class="line">              <span class="keyword">typeof</span> global == <span class="string">'object'</span> &amp;&amp; global.global === global &amp;&amp; global ||</span><br><span class="line">              <span class="keyword">this</span> ||</span><br><span class="line">              &#123;&#125;;</span><br></pre></td></tr></table></figure>
<p>上面是<a href="https://underscorejs.org/" target="_blank" rel="noopener">underscore1.9.1</a>IIFE函数中的源码，对应于我们上面自己写的<code>var root = this;</code>。</p>
<p>在源码中作者也解释了：创建root对象，并且给root赋值：</p>
<blockquote>
<p>浏览器端：window也可以是window.self或者直接self</p>
<p>服务端（node）：global</p>
<p>WebWorker：self</p>
<p>虚拟机：this</p>
</blockquote>
<p>underscore充分考虑了兼容性。</p>
<h3 id="支持两种不同风格的函数调用"><a href="#支持两种不同风格的函数调用" class="headerlink" title="支持两种不同风格的函数调用"></a>支持两种不同风格的函数调用</h3><p>在underscore中我们可以使用两种方式调用函数：</p>
<ol>
<li>函数式的调用：<code>console.log(_.first([1,2,3,4]));</code></li>
<li>对象式调用：<code>console.log(_([1,2,3,4])).first();</code></li>
</ol>
<p>在underscore中，它们返回的结果都是相同的。</p>
<p>第一种方式没有问题，难点就是第二种方式的调用。</p>
<h4 id="对象式调用的实现"><a href="#对象式调用的实现" class="headerlink" title="对象式调用的实现"></a>对象式调用的实现</h4><p>解决这个问题要达到两个目的：</p>
<ol>
<li><code>_</code>是一个函数，并且调用返回一个对象；</li>
<li>这个对象依然能够调用挂载在<code>_</code>对象上声明的方法。</li>
</ol>
<p>我们来看看underscore对于<code>_</code>的实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> _ = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> _) <span class="keyword">return</span> obj;</span><br><span class="line">      <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> _)) <span class="keyword">return</span> <span class="keyword">new</span> _(obj);</span><br><span class="line">      <span class="keyword">this</span>._wrapped = obj;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><img src="http://p3.pstatp.com/large/pgc-image/1523714090989c11ac2a799" alt="ç¸éåç"></p>
<p>不怕，我们不妨调用<code>_([1,2,3,4]))</code>看看他是怎么执行的！</p>
<p><strong>第一步</strong>：<code>if (obj instanceof _) return obj;</code>传入的对象及其原型链上有<code>_</code>类型的对象，则返回自身。我们这里的<code>[1,2,3,4]</code>显然不是，跳过。</p>
<p><strong>第二步</strong>：<code>if (!(this instanceof _)) return new _(obj);</code>，如果当前的this对象及其原型链上没有<code>_</code>类型的对象，那么执行<code>new</code>操作。调用<code>_([1,2,3,4]))</code>时，<code>this</code>为<code>window</code>，那么<code>(this instanceof _)</code>为<code>false</code>，所以我们执行<code>new _([1,2,3,4])</code>。</p>
<p><strong>第三步</strong>：执行<code>new _([1,2,3,4])</code>，继续调用<code>_</code>函数，这时</p>
<blockquote>
<p><code>obj</code>为<code>[1,2,3,4]</code></p>
<p><code>this</code>为一个新对象，并且这个对象的<code>__proto__</code>指向<code>_.prototype</code>(对于new对象执行有疑问，请猛戳<a href="https://juejin.im/post/5c6ed96ae51d450da463513c" target="_blank" rel="noopener">此处</a>)</p>
</blockquote>
<p>此时</p>
<blockquote>
<p><code>(obj instanceof _)</code>为<code>false</code></p>
<p><code>(this instanceof _)</code>为<code>true</code></p>
</blockquote>
<p>所以此处会执行<code>this._wrapped = obj;</code>，在新对象中，添加<code>_wrapped</code>属性，将<code>[1,2,3,4]</code>挂载进去。</p>
<p>综合上述函数实现的效果就是：</p>
<p><code>_([1,2,3,4]))&lt;=====&gt;new _([1,2,3,4])</code></p>
<p>然后执行如下构造函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> _ = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">this</span>._wrapped = obj</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后得到的对象为：</p>
<p><img src="/2019/03/07/跟underscore一起学如何写函数库/image-20190306201849178.png" alt="image-20190306201849178"></p>
<p><img src="/2019/03/07/跟underscore一起学如何写函数库/image-20190306235445836.png" alt="image-20190306235445836"></p>
<p>我们执行如下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(_([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]));</span><br><span class="line"><span class="built_in">console</span>.log(_.prototype);</span><br><span class="line"><span class="built_in">console</span>.log(_([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]).__proto__ == _.prototype);</span><br></pre></td></tr></table></figure>
<p>看一下打印的信息：</p>
<p><img src="/2019/03/07/跟underscore一起学如何写函数库/image-20190306214133549.png" alt="image-20190306214133549"></p>
<p>这表明通过<code>_（obj）</code>构建出来的对象确实具有两个特征：</p>
<ol>
<li>下面挂载了我们传入的对象或数组</li>
<li>对象的<code>_proto_</code>属性指向<code>_</code>的<code>prototype</code></li>
</ol>
<p>到此我们已经完成了第一个问题。</p>
<p><img src="/2019/03/07/跟underscore一起学如何写函数库/phpcode1539082657ex9plP.png" alt="ãææ­£æ¯ä¸ªå¤©æ è¡¨æåãçåçæå°çµæ"></p>
<p>接着解决第二个问题：</p>
<p><strong>这个对象依然能够调用挂载在<code>_</code>对象上声明的方法</strong></p>
<p>我们先来执行如下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]).first();</span><br></pre></td></tr></table></figure>
<p>此时JavaScript执行器会先去找<code>_([1,2,3,4])</code>返回的对象上是否有<code>first</code>属性，如果没有就会顺着对象的原型链上去找<code>first</code>属性，直到找到并执行它。</p>
<p>我们发现<code>_([1,2,3,4])</code>返回的对象属性和原型链上都没有<code>first</code>！</p>
<p><img src="/2019/03/07/跟underscore一起学如何写函数库/image-20190307000429320.png" alt="image-20190307000429320"></p>
<p>那我们自己先在<code>_.prototype</code>上面加一个上去试一下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">//定义</span></span><br><span class="line">    <span class="keyword">var</span> root = <span class="keyword">typeof</span> self == <span class="string">'object'</span> &amp;&amp; self.self === self &amp;&amp; self ||</span><br><span class="line">    <span class="keyword">typeof</span> global == <span class="string">'object'</span> &amp;&amp; global.global === global &amp;&amp; global ||</span><br><span class="line">    <span class="keyword">this</span> ||</span><br><span class="line">    &#123;&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> _ = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> _) <span class="keyword">return</span> obj;</span><br><span class="line">        <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> _)) <span class="keyword">return</span> <span class="keyword">new</span> _(obj);</span><br><span class="line">        <span class="keyword">this</span>._wrapped = obj;</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">    _.first = <span class="function"><span class="keyword">function</span>(<span class="params">arr,n=<span class="number">0</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(n==<span class="number">0</span>) <span class="keyword">return</span> arr[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">return</span> arr.slice(<span class="number">0</span>,n);</span><br><span class="line">    &#125;</span><br><span class="line">    _.prototype.first = <span class="function"><span class="keyword">function</span>(<span class="params">arr,n=<span class="number">0</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(n==<span class="number">0</span>) <span class="keyword">return</span> arr[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">return</span> arr.slice(<span class="number">0</span>,n);</span><br><span class="line">    &#125;</span><br><span class="line">    root._ = _;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<p>我们在执行打印一下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(_([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]));</span><br></pre></td></tr></table></figure>
<p>效果如下：</p>
<p><img src="/2019/03/07/跟underscore一起学如何写函数库/image-20190306214554433.png" alt="image-20190306214554433"></p>
<p>原型链上找到了<code>first</code>函数，我们可以调用<code>first</code>函数了。如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(_([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]).first());</span><br></pre></td></tr></table></figure>
<p>可惜报错了：</p>
<p><img src="/2019/03/07/跟underscore一起学如何写函数库/image-20190306214848922.png" alt="image-20190306214848922"></p>
<p>于是调试一下：<br><img src="/2019/03/07/跟underscore一起学如何写函数库/image-20190306214932983.png" alt="image-20190306214932983"></p>
<p>我们发现<code>arr</code>是<code>undefined</code>，但是我们希望<code>arr</code>是<code>[1,2,3,4]</code>。</p>
<p><img src="/2019/03/07/跟underscore一起学如何写函数库/heheda.png" alt="ãä¸æ è¡¨æåãçåçæå°çµæ"></p>
<p>我们马上改一下<code>_.prototype.first</code>的实现</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> root = <span class="keyword">typeof</span> self == <span class="string">'object'</span> &amp;&amp; self.self === self &amp;&amp; self ||</span><br><span class="line">    <span class="keyword">typeof</span> global == <span class="string">'object'</span> &amp;&amp; global.global === global &amp;&amp; global ||</span><br><span class="line">    <span class="keyword">this</span> ||</span><br><span class="line">    &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> _ = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> _) <span class="keyword">return</span> obj;</span><br><span class="line">        <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> _)) <span class="keyword">return</span> <span class="keyword">new</span> _(obj);</span><br><span class="line">        <span class="keyword">this</span>._wrapped = obj;</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">    _.first = <span class="function"><span class="keyword">function</span>(<span class="params">arr,n=<span class="number">0</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(n==<span class="number">0</span>) <span class="keyword">return</span> arr[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">return</span> arr.slice(<span class="number">0</span>,n);</span><br><span class="line">    &#125;</span><br><span class="line">    _.prototype.first = <span class="function"><span class="keyword">function</span>(<span class="params">arr,n=<span class="number">0</span></span>)</span>&#123;</span><br><span class="line">        arr = <span class="keyword">this</span>._wrapped;</span><br><span class="line">        <span class="keyword">if</span>(n==<span class="number">0</span>) <span class="keyword">return</span> arr[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">return</span> arr.slice(<span class="number">0</span>,n);</span><br><span class="line">    &#125;</span><br><span class="line">    root._ = _;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<p>我们在执行一下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(_([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]).first());</span><br></pre></td></tr></table></figure>
<p>效果如下：</p>
<p><img src="/2019/03/07/跟underscore一起学如何写函数库/image-20190306215555025.png" alt="image-20190306215555025"></p>
<p>我们的效果似乎已经达到了！</p>
<p><img src="/2019/03/07/跟underscore一起学如何写函数库/20170606015124803.png" alt="ãèµ è¡¨æåãçåçæå°çµæ"></p>
<p>现在我们执行下面的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(_([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]).first(<span class="number">2</span>));</span><br></pre></td></tr></table></figure>
<p>调试一下：</p>
<p><img src="/2019/03/07/跟underscore一起学如何写函数库/image-20190306215729756.png" alt="image-20190306215729756"></p>
<p>凉凉了。</p>
<p><img src="/2019/03/07/跟underscore一起学如何写函数库/DoiNZIvT.png" alt="ãåå è¡¨æåãçåçæå°çµæ"></p>
<p>其实我们希望的是：</p>
<blockquote>
<p> 将<code>[1,2,3,4]</code>和<code>2</code>以<code>arguments</code>的形式传入first函数</p>
</blockquote>
<p>我们再来改一下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//_.prototype.first = function(arr,n=0)&#123;</span></span><br><span class="line">    <span class="comment">// arr = this._wrapped;</span></span><br><span class="line">    <span class="comment">// if(n==0) return arr[0];</span></span><br><span class="line">    <span class="comment">// return arr.slice(0,n);</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line">_.prototype.first=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 搜集待传入的参数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">var</span> that = <span class="keyword">this</span>._wrapped;</span><br><span class="line">    <span class="keyword">var</span> args = [that].concat(<span class="built_in">Array</span>.from(<span class="built_in">arguments</span>));</span><br><span class="line">    <span class="built_in">console</span>.log(args); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们再执行下面代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]).first(<span class="number">2</span>);</span><br></pre></td></tr></table></figure>
<p>看一下打印的效果：</p>
<p><img src="/2019/03/07/跟underscore一起学如何写函数库/image-20190306220704637.png" alt="image-20190306220704637"></p>
<p>参数都已经拿到了。</p>
<p>我们调用函数一下<code>first</code>函数，我们继续改代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">_.prototype.first=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * 搜集待传入的参数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="keyword">var</span> that = <span class="keyword">this</span>._wrapped;</span><br><span class="line">     <span class="keyword">var</span> args = [that].concat(<span class="built_in">Array</span>.from(<span class="built_in">arguments</span>));</span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * 调用在_属性上的first函数</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">     <span class="keyword">return</span> _.first(...args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样一来_.prototype上面的函数的实际实现都省掉了，相当于做一层<strong>代理</strong>，调用一下。</p>
<p>一举两得！</p>
<p>执行一下最初我们的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">console.log(_.first([1,2,3,4]));</span><br><span class="line">console.log(_.first([1,2,3,4],1));</span><br><span class="line">console.log(_.first([1,2,3,4],3));</span><br></pre></td></tr></table></figure>
<p><img src="/2019/03/07/跟underscore一起学如何写函数库/image-20190306221231484.png" alt="image-20190306221231484"></p>
<p>现在好像我们所有的问题都解决了。</p>
<p><img src="/2019/03/07/跟underscore一起学如何写函数库/1507598461-2836.png" alt="ãèµ è¡¨æåãçåçæå°çµæ"></p>
<p>但是似乎每声明一个函数都得在原型链上也声明一个相同名字的函数。形如下面：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">_.a = <span class="function"><span class="keyword">function</span>(<span class="params">args</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//a的实现</span></span><br><span class="line">&#125;</span><br><span class="line">_.prototype.a = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">//调用_.a(args)</span></span><br><span class="line">&#125;</span><br><span class="line">_.b = <span class="function"><span class="keyword">function</span>(<span class="params">args</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//b的实现</span></span><br><span class="line">&#125;</span><br><span class="line">_.prototype.b = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">//调用_.b(args)</span></span><br><span class="line">&#125;</span><br><span class="line">_.c = <span class="function"><span class="keyword">function</span>(<span class="params">args</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//c的实现</span></span><br><span class="line">&#125;</span><br><span class="line">_.prototype.c = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">//调用_.c(args)</span></span><br><span class="line">&#125;</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line"><span class="number">1000</span>个函数之后...</span><br></pre></td></tr></table></figure>
<p>会不会觉得太恐怖了!</p>
<p><img src="/2019/03/07/跟underscore一起学如何写函数库/phpcode1520358163TxhEt5.png" alt="ãå®³æ è¡¨æåãçåçæå°çµæ"></p>
<p>我们能不能改成如下这样呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">_.a = function(args)&#123;</span><br><span class="line">    //a的实现</span><br><span class="line">&#125;</span><br><span class="line">_.b = function(args)&#123;</span><br><span class="line">    //b的实现</span><br><span class="line">&#125;</span><br><span class="line">_.c = function(args)&#123;</span><br><span class="line">    //c的实现</span><br><span class="line">&#125;</span><br><span class="line">1000个函数之后...</span><br><span class="line">_.mixin = function()&#123;</span><br><span class="line">    //将_属性中声明的函数都挂载在_prototype上面</span><br><span class="line">&#125;</span><br><span class="line">_.mixin(_);</span><br></pre></td></tr></table></figure>
<p>上面这么做好处大大的：</p>
<p><strong>我们可以专注于函数库的实现，不用机械式的复写prototype上的函数</strong>。</p>
<p>underscore也正是这么做的！</p>
<p>我们看看<code>mixin</code>函数在underscore中的源码实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Add your own custom functions to the Underscore object.</span></span><br><span class="line">_.mixin = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">   _.each(_.functions(obj), <span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">   <span class="keyword">var</span> func = _[name] = obj[name];</span><br><span class="line">      _.prototype[name] = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="keyword">var</span> args = [<span class="keyword">this</span>._wrapped];</span><br><span class="line">          push.apply(args, <span class="built_in">arguments</span>);</span><br><span class="line">          <span class="keyword">return</span> chainResult(<span class="keyword">this</span>, func.apply(_, args));</span><br><span class="line">      &#125;;</span><br><span class="line">   &#125;);</span><br><span class="line">    <span class="keyword">return</span> _;</span><br><span class="line">&#125;;</span><br><span class="line">  </span><br><span class="line"><span class="comment">// Add all of the Underscore functions to the wrapper object.</span></span><br><span class="line">_.mixin(_);</span><br></pre></td></tr></table></figure>
<p>有了上面的铺垫，这个代码一点都不难看懂，首先调用<code>_.each</code>函数，形式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">_.each(arrs, function(item) &#123;</span><br><span class="line">    //遍历arrs数组中的每一个元素</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们一想就明白，我们在<code>_</code>对象属性上实现了自己定义的函数，那么现在要把它们挂载到<code>_</code>的<code>prototype</code>属性上面，当然先要遍历它们了。</p>
<p>所以我们可以猜到<code>_.functions(obj)</code>肯定返回的是一个数组，而且这个数组肯定是存储<code>_</code>对象属性上面关于我们实现的各个函数的信息。</p>
<p>我们看一下<code>_.function(obj)</code>的实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">_.functions = _.methods = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> names = [];</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   **  遍历对象中的属性</span></span><br><span class="line"><span class="comment">   **/</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> obj) &#123;</span><br><span class="line">      <span class="comment">//如果属性值是函数，那么存入names数组中</span></span><br><span class="line">     <span class="keyword">if</span> (_.isFunction(obj[key])) names.push(key);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> names.sort();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>确实是这样的！</p>
<p><img src="/2019/03/07/跟underscore一起学如何写函数库/98c5ee483d3b1d15a6028724289501ee.png" alt="ãæè² è¡¨æåãçåçæå°çµæ"></p>
<p>我们把上述实现的代码整合起来：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保证兼容性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">var</span> root = <span class="keyword">typeof</span> self == <span class="string">'object'</span> &amp;&amp; self.self === self &amp;&amp; self ||</span><br><span class="line">    <span class="keyword">typeof</span> global == <span class="string">'object'</span> &amp;&amp; global.global === global &amp;&amp; global ||</span><br><span class="line">    <span class="keyword">this</span> ||</span><br><span class="line">    &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在调用_(obj)时，让其执行new _(obj),并将obj挂载在_wrapped属性之下</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">var</span> _ = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> _) <span class="keyword">return</span> obj;</span><br><span class="line">        <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> _)) <span class="keyword">return</span> <span class="keyword">new</span> _(obj);</span><br><span class="line">        <span class="keyword">this</span>._wrapped = obj;</span><br><span class="line">      &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//自己实现的first函数</span></span><br><span class="line">    _.first = <span class="function"><span class="keyword">function</span>(<span class="params">arr,n=<span class="number">0</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(n==<span class="number">0</span>) <span class="keyword">return</span> arr[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">return</span> arr.slice(<span class="number">0</span>,n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断是否是函数</span></span><br><span class="line">    _.isFunction = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">typeof</span> obj == <span class="string">'function'</span> || <span class="literal">false</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//遍历生成数组存储_对象的函数值属性</span></span><br><span class="line">    _.functions = _.methods = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> names = [];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> obj) &#123;</span><br><span class="line">          <span class="keyword">if</span> (_.isFunction(obj[key])) names.push(key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> names.sort();</span><br><span class="line">      &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//自己实现的遍历数组的函数</span></span><br><span class="line">    _.each = <span class="function"><span class="keyword">function</span>(<span class="params">arrs,callback</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;arrs.length;i++)&#123;</span><br><span class="line">            callback(arrs[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> ArrayProto = <span class="built_in">Array</span>.prototype;</span><br><span class="line">    <span class="keyword">var</span> push = ArrayProto.push;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//underscore实现的mixin函数</span></span><br><span class="line">    _.mixin = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(_.functions(obj)); <span class="comment">//我们打印一下_.functions(_)到底存储了什么？</span></span><br><span class="line">        _.each(_.functions(obj), <span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">var</span> func = _[name] = obj[name];</span><br><span class="line">           _.prototype[name] = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">               <span class="keyword">var</span> args = [<span class="keyword">this</span>._wrapped];</span><br><span class="line">               push.apply(args, <span class="built_in">arguments</span>);</span><br><span class="line">               <span class="keyword">return</span> func.apply(_, args);</span><br><span class="line">           &#125;;</span><br><span class="line">        &#125;);</span><br><span class="line">         <span class="keyword">return</span> _;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//执行minxin函数</span></span><br><span class="line">    _.mixin(_);</span><br><span class="line">    root._ = _;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<p>我们看一下<code>_.functions(obj)</code>返回的打印信息：</p>
<p><img src="/2019/03/07/跟underscore一起学如何写函数库/image-20190306224747300.png" alt="image-20190306224747300"></p>
<p>确实是<code>_</code>中自定义函数的属性值。</p>
<p>我们再来分析一下each中callback遍历各个属性的实现逻辑。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> func = _[name] = obj[name];</span><br><span class="line"> _.prototype[name] = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">     <span class="keyword">var</span> args = [<span class="keyword">this</span>._wrapped];</span><br><span class="line">      push.apply(args, <span class="built_in">arguments</span>);</span><br><span class="line">     <span class="keyword">return</span> func.apply(_, args);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>第一句：<code>func</code>变量存储每个自定义函数</p>
<p>第二句： <code>_.prototype[name]=function();</code>在_.prototype上面也声明相同属性的函数</p>
<p>第三句：<code>args</code>变量存储<code>_wrapped</code>下面挂载的值</p>
<p>第四句：跟<code>var args = [that].concat(Array.from(arguments));</code>作用相似，将两边的参数结合起来</p>
<p>第五句：执行<code>func</code>变量指向的函数，执行<code>apply</code>函数，将上下文对象<code>_</code>和待传入的参数`args``传入即可。</p>
<p>我们再执行以下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(_.first([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]));</span><br><span class="line"><span class="built_in">console</span>.log(_.first([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>],<span class="number">1</span>));</span><br><span class="line"><span class="built_in">console</span>.log(_.first([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>],<span class="number">3</span>));</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<p><img src="/2019/03/07/跟underscore一起学如何写函数库/image-20190306230712917.png" alt="image-20190306230712917"></p>
<p>Perfect！</p>
<p>这个函数在我们的浏览器中使用已经没有问题。</p>
<p>但是在Node中呢？所以下面引出新的问题。</p>
<h3 id="再回归兼容性问题"><a href="#再回归兼容性问题" class="headerlink" title="再回归兼容性问题"></a>再回归兼容性问题</h3><p>我们知道在Node中，我们是这样的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//a.js</span></span><br><span class="line"><span class="keyword">let</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="built_in">module</span>.exports = a;</span><br><span class="line"><span class="comment">//index.js</span></span><br><span class="line"><span class="keyword">let</span> b = <span class="built_in">require</span>(<span class="string">'./a.js'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(b) <span class="comment">//打印1</span></span><br></pre></td></tr></table></figure>
<p>那么：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> _ = <span class="built_in">require</span>(<span class="string">'./underscore.js'</span>)</span><br><span class="line">_([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]).first(<span class="number">2</span>);</span><br></pre></td></tr></table></figure>
<p>我们也希望上述的代码能够在Node中执行。</p>
<p>所以<code>root._ = _</code>是不够的。</p>
<p>underscore是怎么做的呢？</p>
<p>如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> exports != <span class="string">'undefined'</span> &amp;&amp; !exports.nodeType) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">module</span> != <span class="string">'undefined'</span> &amp;&amp; !<span class="built_in">module</span>.nodeType &amp;&amp; <span class="built_in">module</span>.exports) &#123;</span><br><span class="line">        exports = <span class="built_in">module</span>.exports = _;</span><br><span class="line">    &#125;</span><br><span class="line">    exports._ = _;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    root._ = _;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看到当全局属性exports不存在或者不是DOM节点时，说明它在浏览器中，所以：</p>
<p><code>root._ = _;</code></p>
<p>如果exports存在，那么就是在Node环境下，我们再来进行判断：</p>
<p>如果module存在，并且不是DOM节点，并且module.exports也存在的话，那么执行：</p>
<p><code>exports = module.exports = _;</code></p>
<p>在统一执行：</p>
<p><code>exports._ = _;</code></p>
<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p>下面是最后整合的阉割版underscore代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保证兼容性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">var</span> root = <span class="keyword">typeof</span> self == <span class="string">'object'</span> &amp;&amp; self.self === self &amp;&amp; self ||</span><br><span class="line">    <span class="keyword">typeof</span> global == <span class="string">'object'</span> &amp;&amp; global.global === global &amp;&amp; global ||</span><br><span class="line">    <span class="keyword">this</span> ||</span><br><span class="line">    &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在调用_(obj)时，让其执行new _(obj),并将obj挂载在_wrapped属性之下</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">var</span> _ = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> _) <span class="keyword">return</span> obj;</span><br><span class="line">        <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> _)) <span class="keyword">return</span> <span class="keyword">new</span> _(obj);</span><br><span class="line">        <span class="keyword">this</span>._wrapped = obj;</span><br><span class="line">      &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//自己实现的first函数</span></span><br><span class="line">    _.first = <span class="function"><span class="keyword">function</span>(<span class="params">arr,n=<span class="number">0</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(n==<span class="number">0</span>) <span class="keyword">return</span> arr[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">return</span> arr.slice(<span class="number">0</span>,n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断是否是函数</span></span><br><span class="line">    _.isFunction = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">typeof</span> obj == <span class="string">'function'</span> || <span class="literal">false</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//遍历生成数组存储_对象的函数值属性</span></span><br><span class="line">    _.functions = _.methods = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> names = [];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> obj) &#123;</span><br><span class="line">          <span class="keyword">if</span> (_.isFunction(obj[key])) names.push(key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> names.sort();</span><br><span class="line">      &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//自己实现的遍历数组的函数</span></span><br><span class="line">    _.each = <span class="function"><span class="keyword">function</span>(<span class="params">arrs,callback</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;arrs.length;i++)&#123;</span><br><span class="line">            callback(arrs[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> ArrayProto = <span class="built_in">Array</span>.prototype;</span><br><span class="line">    <span class="keyword">var</span> push = ArrayProto.push;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//underscore实现的mixin函数</span></span><br><span class="line">    _.mixin = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">        _.each(_.functions(obj), <span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> func = _[name] = obj[name];</span><br><span class="line">           _.prototype[name] = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">               <span class="keyword">var</span> args = [<span class="keyword">this</span>._wrapped];</span><br><span class="line">               push.apply(args, <span class="built_in">arguments</span>);</span><br><span class="line">               <span class="keyword">return</span> func.apply(_, args);</span><br><span class="line">           &#125;;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> _;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//执行minxin函数</span></span><br><span class="line">    _.mixin(_);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> exports != <span class="string">'undefined'</span> &amp;&amp; !exports.nodeType) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">module</span> != <span class="string">'undefined'</span> &amp;&amp; !<span class="built_in">module</span>.nodeType &amp;&amp; <span class="built_in">module</span>.exports) &#123;</span><br><span class="line">            exports = <span class="built_in">module</span>.exports = _;</span><br><span class="line">        &#125;</span><br><span class="line">        exports._ = _;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        root._ = _;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<p>欢迎各位大佬拍砖！同时您的点赞是我写作的动力~谢谢。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhehuaxuan.github.io/2019/03/05/translation/CSSOM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZheHuaXuan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhehua's note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/05/translation/CSSOM/" itemprop="url">【译】CSS对象模型（CSSOM）指南</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-05T23:43:23+08:00">
                2019-03-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CSS/" itemprop="url" rel="index">
                    <span itemprop="name">CSS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>作者：<a href="https://css-tricks.com/author/lazaris/" target="_blank" rel="noopener">Louis Lazaris</a></p>
<p>原文链接：<a href="https://css-tricks.com/an-introduction-and-guide-to-the-css-object-model-cssom/" target="_blank" rel="noopener">https://css-tricks.com/an-introduction-and-guide-to-the-css-object-model-cssom/</a></p>
</blockquote>
<p>如果您已经写了一段时间的JavaScript，那么可以肯定您使用过用于处理<strong>文档对象模型（DOM）</strong>的脚本。DOM脚本利用网页提供的一组API（或接口）来操作和处理页面上的元素。</p>
<p>那么，您应该还熟悉另一个对象模型：CSS对象模型（CSSOM），可能你已经在无意识的时候使用过它。</p>
<p>在这篇文章中，我将介绍CSSOM的许多重要的功能，从最常见的开始，慢慢转向一些大家不清楚但很实用的小功能。</p>
<h3 id="什么是CSSOM"><a href="#什么是CSSOM" class="headerlink" title="#什么是CSSOM?"></a><a href="https://css-tricks.com/an-introduction-and-guide-to-the-css-object-model-cssom/#article-header-id-0" target="_blank" rel="noopener">#</a>什么是CSSOM?</h3><p><a href="https://developer.mozilla.org/en-US/docs/Web/API/CSS_Object_Model" target="_blank" rel="noopener">根据MDN</a>:</p>
<blockquote>
<p>CSS对象模型是JavaScript处理CSS的API。它很像DOM，只是面向CSS而不是HTML。它允许用户动态地读取和修改CSS样式。 </p>
</blockquote>
<p>MDN的信息基于 <a href="https://drafts.csswg.org/cssom/" target="_blank" rel="noopener">官方的W3C CSSOM规范</a>. 用W3C文档来熟悉CSSOM的是一种低效的方式，也不适用于那些正在寻找一些实际编码示例的人。</p>
<p>使用MDN显然会好得多，虽然在某些方面仍然很缺乏。因此，对于这篇文章，我试图尽力的去创建有用的代码示例来演示，这样您就可以通过实际代码解除疑惑。</p>
<p>就像上面所说，文章从大多数前端开发人员熟悉的内容开始。里面有一些公有属性常常和DOM脚本混在一起，但是CSSOM的API还是占了很大一部分。</p>
<h3 id="使用element-style获取内联样式"><a href="#使用element-style获取内联样式" class="headerlink" title="#使用element.style获取内联样式"></a><a href="https://css-tricks.com/an-introduction-and-guide-to-the-css-object-model-cssom/#article-header-id-1" target="_blank" rel="noopener">#</a>使用element.style获取内联样式</h3><p>使用JavaScript操作和获取CSS属性和值的最基本方法是通过<code>style</code>对象或属性，这个对象和属性往往对于所有的HTML元素都适用。这里有一个例子： </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.body.style.background = <span class="string">'lightblue'</span>;</span><br></pre></td></tr></table></figure>
<p>大多数人之前可能已经看过或用过这种语法。我可以使用<code>element.style.propertyName</code>.的格式为页面上的任何对象添加或更改CSS 。</p>
<p>在上述例子中，我正在将<code>background</code>属性的值更改为<code>lightblue</code>。当然，<code>background</code>是“短属性”（只有一个单词组成的属性）。如果我只想更改<code>background-color</code>属性怎么办？对于任何带连字符的属性，只需将属性名称转换为驼峰法的形式，如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.body.style.backgroundColor = <span class="string">'lightblue'</span>;</span><br></pre></td></tr></table></figure>
<p>在大多数情况下，“短属性”以小写单词的形式表示和访问，而“连字符属性”用驼峰法表示。但是有一个例外是使用<code>float</code>属性。因为<code>float</code>是JavaScript中的保留字，所以您需要使用<code>cssFloat</code>（如果您支持IE8及更早版本，请使用<code>styleFloat</code>）。这类似于HTML中的<code>for</code>属性，我们使用<code>htmlFor</code> 来表示。</p>
<p>下面是一个使用<code>style</code>属性来允许用户更改当前页面背景颜色的例子：</p>
<iframe height="665" style="width: 100%;" scrolling="no" title="GzWBxP" src="//codepen.io/zhehuaxuan/embed/GzWBxP/?height=265&theme-id=dark&default-tab=html,result" frameborder="no" allowtransparency="true" allowfullscreen="true"><br>  See the Pen <a href="https://codepen.io/zhehuaxuan/pen/GzWBxP/" target="_blank" rel="noopener">GzWBxP</a> by 宣浙华<br>  (<a href="https://codepen.io/zhehuaxuan" target="_blank" rel="noopener">@zhehuaxuan</a>) on <a href="https://codepen.io" target="_blank" rel="noopener">CodePen</a>.<br></iframe>

<p>我们使用JavaScript定义CSS属性和值虽然简单方法，但是使用<code>style</code>属性有一个很大的前提：<strong>只适用于元素的内联样式</strong>。</p>
<p>当您使用该<code>style</code>属性读取CSS 时，这一点变得清晰：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.body.style.backgroundColor = <span class="string">'lightblue'</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">document</span>.body.style.backgroundColor);</span><br><span class="line"><span class="comment">// "lightblue"</span></span><br></pre></td></tr></table></figure>
<p>在上面的例子中，我在<code>&lt;body&gt;</code>元素上定义了一个内联样式，然后我将相同的样式输出到控制台。但是如果我尝试去读取<code>style</code>的另一个属性的值时，它将不返回任何内容 - 除非是我之前在CSS或JavaScript中定义的内联样式。例如： </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="built_in">document</span>.body.style.color);</span><br><span class="line"><span class="comment">// Returns nothing if inline style doesn't exist</span></span><br></pre></td></tr></table></figure>
<p>即使我使用外部样式表的<code>color</code> 属性去修饰<code>&lt;body&gt;</code> 元素，也同样获取不到值，如下所示：</p>
<div class="cp_embed_wrapper resizable" style="height: 434px;"><iframe name="cp_embed_2" src="https://codepen.io/impressivewebs/embed/LXPewe?height=434&amp;theme-id=1&amp;slug-hash=LXPewe&amp;default-tab=result&amp;user=impressivewebs&amp;pen-title=element.style%20Reads%20Only%20Inline%20Styles&amp;name=cp_embed_2" scrolling="no" frameborder="0" height="434" allowtransparency="true" allowfullscreen="true" allowpaymentrequest="true" title="element.style只读取内联样式" class="cp_embed_iframe " style="width: 100%; overflow: hidden; display: block; height: 100%;" id="cp_embed_LXPewe"></iframe><div class="win-size-grip" style="touch-action: none;"></div><div class="win-size-grip" style="touch-action: none;"></div><div class="win-size-grip" style="touch-action: none;"></div><div class="win-size-grip" style="touch-action: none;"></div></div>

<p>通过JavaScript使用<code>element.style</code>的方式去改变元素的属性是最简单和通用的方式，但是你也看到这里很明显有很大的限制，让我们继续来看一下JavaScript还有那些更好用的方式去读取和修改我们的样式。</p>
<h3 id="获取Computed样式"><a href="#获取Computed样式" class="headerlink" title="#获取Computed样式"></a><a href="https://css-tricks.com/an-introduction-and-guide-to-the-css-object-model-cssom/#article-header-id-2" target="_blank" rel="noopener">#</a>获取Computed样式</h3><p>您可以使用<code>window.getComputedStyle()</code> 方法来读取元素上的任何CSS属性：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.getComputedStyle(<span class="built_in">document</span>.body).background;</span><br><span class="line"><span class="comment">// "rgba(0, 0, 0, 0) none repeat scroll 0% 0% / auto padding-box border-box"</span></span><br></pre></td></tr></table></figure>
<p>哇！真实一个有意思的结果。在某种程度上，<code>window.getComputedStyle()</code>是<code>style</code>的孪生兄弟。如果直接使用<code>style</code>属性给你提供的元素实际样式信息太少，那么使用<code>window.getComputedStyle()</code>会给您一些启发。</p>
<iframe height="465" style="width: 100%;" scrolling="no" title="使用window.getComputedStyle" src="//codepen.io/zhehuaxuan/embed/NopOMB/?height=465&theme-id=dark&default-tab=html,result" frameborder="no" allowtransparency="true" allowfullscreen="true"></iframe>

<p>在上述示例中，<code>&lt;body&gt;</code>元素的<code>background</code>属性是使用<code>background: papayawhip;</code>定义。但<code>getComputedStyle()</code>方法返回<code>background</code>属性中的所有值，未在CSS中明确定义的那些将返回这个属性的初始（或默认）值。</p>
<p>这意味着，对于任何属性，即使CSS中没有定义它们，使用<code>window.getComputedStyle()</code>仍可以返回所有初始值： </p>
<iframe height="465" style="width: 100%;" scrolling="no" title="window.getComputedStyle()输出初始属性" src="//codepen.io/zhehuaxuan/embed/aXJRXN/?height=465&theme-id=dark&default-tab=html,result" frameborder="no" allowtransparency="true" allowfullscreen="true"></iframe>

<p>类似地，比如<code>width</code>和<code>height</code>这样的属性，不管这些值是否在CSS中的任何位置定义，它将显示元素对应属性的计算值，如下面的示例所示： </p>
<iframe height="465" style="width: 100%;" scrolling="no" title="计算元素的width和height" src="//codepen.io/zhehuaxuan/embed/PVpyra/?height=465&theme-id=dark&default-tab=html,result" frameborder="no" allowtransparency="true" allowfullscreen="true"></iframe>

<p>尝试调整上面示例中的父元素大小以查看结果。这类似于读取<code>window.innerWidth</code>值，只是在这边是去获取指定元素上指定属性的CSS值，而不仅仅是一般的窗口或视口。</p>
<p>这里我们使用<code>window.getComputedStyle()</code>方法中的几种方式来访问。我已经演示了其中的一种方法，它使用<strong>点符号+驼峰式属性名称</strong>的方式添加到方法的末尾。您可以在以下代码中看到三种不同的方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dot notation, same as above</span></span><br><span class="line"><span class="built_in">window</span>.getComputedStyle(el).backgroundColor;</span><br><span class="line"></span><br><span class="line"><span class="comment">// square bracket notation</span></span><br><span class="line"><span class="built_in">window</span>.getComputedStyle(el)[<span class="string">'background-color'</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// using getPropertyValue()</span></span><br><span class="line"><span class="built_in">window</span>.getComputedStyle(el).getPropertyValue(<span class="string">'background-color'</span>);</span><br></pre></td></tr></table></figure>
<p>上面第一种方法的形式和先前的那个例子一样。</p>
<p>第二种方式使用中括号将CSS属性用单引号包裹起来，这种方式不推荐，代码编译器会告警。</p>
<p>第三种使用<code>getPropertyValue()</code> 的方式。</p>
<p>在第一个例子中，我们使用骆驼法（在这个例子中，<code>float</code>和<code>cssFloat</code>属性都可以工作），而接下来的两个方法使用相同的语法形式，使用CSS中的属性（连字符，通常被称为“烤肉箱”）。</p>
<p>下面的示例与前一个相同，但这次使用<code>getPropertyValue()</code>访问两个元素的宽度：</p>
<p></p><p class="codepen" data-height="465" data-theme-id="dark" data-default-tab="html,result" data-user="zhehuaxuan" data-slug-hash="pGeQOy" style="height: 265px; box-sizing: border-box; display: flex; align-items: center; justify-content: center; border: 2px solid black; margin: 1em 0; padding: 1em;" data-pen-title="pGeQOy"><br>  <span>See the Pen <a href="https://codepen.io/zhehuaxuan/pen/pGeQOy/" target="_blank" rel="noopener"><br>  pGeQOy</a> by 宣浙华 (<a href="https://codepen.io/zhehuaxuan" target="_blank" rel="noopener">@zhehuaxuan</a>)<br>  on <a href="https://codepen.io" target="_blank" rel="noopener">CodePen</a>.</span><br></p><p></p>
<script async src="https://static.codepen.io/assets/embed/ei.js"></script>

<h3 id="获取伪元素的计算样式"><a href="#获取伪元素的计算样式" class="headerlink" title="#获取伪元素的计算样式"></a><a href="https://css-tricks.com/an-introduction-and-guide-to-the-css-object-model-cssom/#article-header-id-3" target="_blank" rel="noopener">#</a>获取伪元素的计算样式</h3><p>一个鲜为人知的事情是<code>window.getComputedStyle()</code>能够获取伪元素的样式信息。你可以看到 <code>window.getComputedStyle()</code> 方法像如下形式的声明：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.getComputedStyle(<span class="built_in">document</span>.body, <span class="literal">null</span>).width;</span><br></pre></td></tr></table></figure>
<p>请注意第二个参数, <code>null</code>, Firefox的版本4之前的需要第二个参数，这就是为什么你经常在老代码中看到它（目前所有的浏览器都不需要这个参数）。</p>
<p>第二个参数可选，允许我们去获得当前元素的伪元素的属性，如下所示：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.box::before &#123;</span><br><span class="line">  content: 'Example';</span><br><span class="line">  display: block;</span><br><span class="line">  width: 50px;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里，我们给<code>.box</code> 元素添加了一个<code>::before</code> 的伪元素，下面的JavaScript代码用于计算伪元素的属性值：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> box = <span class="built_in">document</span>.querySelector(<span class="string">'.box'</span>);</span><br><span class="line"><span class="built_in">window</span>.getComputedStyle(box, <span class="string">'::before'</span>).width;</span><br><span class="line"><span class="comment">// "50px"</span></span><br></pre></td></tr></table></figure>
<iframe height="465" style="width: 100%;" scrolling="no" title="getComputedStyle() to get styles from a pseudo-element" src="//codepen.io/zhehuaxuan/embed/XOMOoJ/?height=265&theme-id=dark&default-tab=css,result" frameborder="no" allowtransparency="true" allowfullscreen="true"><br>  See the Pen <a href="https://codepen.io/zhehuaxuan/pen/XOMOoJ/" target="_blank" rel="noopener">getComputedStyle() to get styles from a pseudo-element</a> by 宣浙华<br>  (<a href="https://codepen.io/zhehuaxuan" target="_blank" rel="noopener">@zhehuaxuan</a>) on <a href="https://codepen.io" target="_blank" rel="noopener">CodePen</a>.<br></iframe>

<p>您也可以为其他伪元素执行此操作<code>::first-line</code>，如以下代码和演示： </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> p = <span class="built_in">document</span>.querySelector(<span class="string">'.box p'</span>);</span><br><span class="line"><span class="built_in">window</span>.getComputedStyle(p, <span class="string">'::first-line'</span>).color;</span><br></pre></td></tr></table></figure>
<iframe height="465" style="width: 100%;" scrolling="no" title="getComputedStyle() to get styles from a pseudo-element first-line" src="//codepen.io/zhehuaxuan/embed/vbxbMe/?height=265&theme-id=dark&default-tab=html,result" frameborder="no" allowtransparency="true" allowfullscreen="true"><br>  See the Pen <a href="https://codepen.io/zhehuaxuan/pen/vbxbMe/" target="_blank" rel="noopener">getComputedStyle() to get styles from a pseudo-element first-line</a> by 宣浙华<br>  (<a href="https://codepen.io/zhehuaxuan" target="_blank" rel="noopener">@zhehuaxuan</a>) on <a href="https://codepen.io" target="_blank" rel="noopener">CodePen</a>.<br></iframe>

<p>And here’s another example using the <code>::placeholder</code> pseudo-element, which apples to <code>&lt;input&gt;</code>elements:</p>
<p>这里有另外一个例子获取input标签中的<code>::placeholder</code>伪元素的样式信息：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> input = <span class="built_in">document</span>.querySelector(<span class="string">'input'</span>);</span><br><span class="line"><span class="built_in">window</span>.getComputedStyle(input, <span class="string">'::placeholder'</span>).color</span><br></pre></td></tr></table></figure>
<iframe height="465" style="width: 100%;" scrolling="no" title="getComputedStyle() to get styles from a ::placeholder" src="//codepen.io/zhehuaxuan/embed/GzWzVx/?height=265&theme-id=dark&default-tab=html,result" frameborder="no" allowtransparency="true" allowfullscreen="true"><br>  See the Pen <a href="https://codepen.io/zhehuaxuan/pen/GzWzVx/" target="_blank" rel="noopener">getComputedStyle() to get styles from a ::placeholder</a> by 宣浙华<br>  (<a href="https://codepen.io/zhehuaxuan" target="_blank" rel="noopener">@zhehuaxuan</a>) on <a href="https://codepen.io" target="_blank" rel="noopener">CodePen</a>.<br></iframe>

<blockquote>
<p>以上工作在最新的Firefox中，但不适用于Chrome或Edge（我已经为Chrome 提交了错误报告）。</p>
</blockquote>
<p>还应该注意的是，尝试访问不存在（但有效）的伪元素的样式时，浏览器会有不同的结果（<code>::banana</code>伪元素）。您可以使用以下演示在各种浏览器中查看效果： </p>
<iframe height="465" style="width: 100%;" scrolling="no" title="Testing getComputedStyle() on non-existent pseudo-elements" src="//codepen.io/zhehuaxuan/embed/VgpRer/?height=265&theme-id=dark&default-tab=html,result" frameborder="no" allowtransparency="true" allowfullscreen="true"><br>  See the Pen <a href="https://codepen.io/zhehuaxuan/pen/VgpRer/" target="_blank" rel="noopener">Testing getComputedStyle() on non-existent pseudo-elements</a> by 宣浙华<br>  (<a href="https://codepen.io/zhehuaxuan" target="_blank" rel="noopener">@zhehuaxuan</a>) on <a href="https://codepen.io" target="_blank" rel="noopener">CodePen</a>.<br></iframe>

<p>作为本节的一个小点，有一个名为Firefox的方法<a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/getDefaultComputedStyle" target="_blank" rel="noopener"><code>getDefaultComputedStyle()</code></a>，它不是规范的一部分，可能永远不会。 </p>
<h3 id="CSS样式声明API"><a href="#CSS样式声明API" class="headerlink" title="#CSS样式声明API"></a><a href="https://css-tricks.com/an-introduction-and-guide-to-the-css-object-model-cssom/#article-header-id-4" target="_blank" rel="noopener">#</a>CSS样式声明API</h3><p>上面我向您展示如何通过<code>style</code>对象或使用<code>getComputedStyle()</code>函数访问属性，在这两种情况下都暴露了<code>CSSStyleDeclaration</code>接口。</p>
<p>换句话说，以下两行都将返回<code>CSS</code>样式文档<code>body</code>元素上的对象：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.body.style;</span><br><span class="line"><span class="built_in">window</span>.getComputedStyle(<span class="built_in">document</span>.body);</span><br></pre></td></tr></table></figure>
<p>下面是这两个对象返回的快照：</p>
<p><img src="https://css-tricks.com/wp-content/uploads/2018/11/cssstyledeclaration-api.png" alt="The CSSStyleDeclaration API in the DevTools console"></p>
<p><code>getComputedStyle()</code>函数返回的值是只读的，使用<code>element.style</code>可以获取和设置属性，但是像先前提到的，<strong>这些只会影响document的内联样式</strong>。</p>
<h3 id="setProperty-getPropertyValue-和item"><a href="#setProperty-getPropertyValue-和item" class="headerlink" title="#setProperty(), getPropertyValue(), 和item()"></a><a href="https://css-tricks.com/an-introduction-and-guide-to-the-css-object-model-cssom/#article-header-id-5" target="_blank" rel="noopener">#</a>setProperty(), getPropertyValue(), 和item()</h3><p>一旦您以上述方式之一暴露了<code>CSS</code>样式声明对象，您就可以访问许多有用的方法来读取或操作这些值。同样，<code>getComputedStyle()</code>返回值是只读的，但是当通过<code>style</code>属性使用时，可用于获取和设置属性值。</p>
<p>请考虑以下代码和演示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> box = <span class="built_in">document</span>.querySelector(<span class="string">'.box'</span>);</span><br><span class="line"></span><br><span class="line">box.style.setProperty(<span class="string">'color'</span>, <span class="string">'orange'</span>);</span><br><span class="line">box.style.setProperty(<span class="string">'font-family'</span>, <span class="string">'Georgia, serif'</span>);</span><br><span class="line">op.innerHTML = box.style.getPropertyValue(<span class="string">'color'</span>);</span><br><span class="line">op2.innerHTML = <span class="string">`<span class="subst">$&#123;box.style.item(<span class="number">0</span>)&#125;</span>, <span class="subst">$&#123;box.style.item(<span class="number">1</span>)&#125;</span>`</span>;</span><br></pre></td></tr></table></figure>
<iframe height="265" style="width: 100%;" scrolling="no" title="Using three different methods of the CSSStyleDeclaration API" src="//codepen.io/zhehuaxuan/embed/JxWzyy/?height=265&theme-id=dark&default-tab=html,result" frameborder="no" allowtransparency="true" allowfullscreen="true"><br>  See the Pen <a href="https://codepen.io/zhehuaxuan/pen/JxWzyy/" target="_blank" rel="noopener">Using three different methods of the CSSStyleDeclaration API</a> by 宣浙华<br>  (<a href="https://codepen.io/zhehuaxuan" target="_blank" rel="noopener">@zhehuaxuan</a>) on <a href="https://codepen.io" target="_blank" rel="noopener">CodePen</a>.<br></iframe>

<p>在这个例子中，我使用了三种不同的<code>style</code>对象方法： </p>
<ul>
<li><code>setProperty()</code>方法。这需要两个参数，每个参数都是一个字符串：属性（以常规CSS表示法）和属性值</li>
<li><code>getPropertyValue()</code>方法。这需要一个参数，你想要获得的属性。和前面提到的<code>getComputedStyle()</code>方法一样，返回 <code>CSSStyleDeclaration</code> 对象。</li>
<li><code>item()</code>方法。这需要使用一个参数，这需要一个参数，它是一个正整数，表示您要访问的属性的索引。返回值是该索引处的属性名称。</li>
</ul>
<p>注意，在我上面的简单示例中，只有两个样式添加到元素的内联CSS中。这意味着如果我要访问<code>item(2)</code>，返回值将是一个空字符串。如果我<code>getPropertyValue()</code>以前访问未在该元素的内联样式中设置的属性，也会得到相同的结果。 </p>
<h3 id="使用removeProperty"><a href="#使用removeProperty" class="headerlink" title="# 使用removeProperty()"></a><a href="https://css-tricks.com/an-introduction-and-guide-to-the-css-object-model-cssom/#article-header-id-6" target="_blank" rel="noopener">#</a> 使用removeProperty()</h3><p>除了上面提到的三种方法之外，还有另外两种方法暴露<code>CSS</code>样式声明对象。在下面的代码和示例中，我将使用<code>removeProperty()</code>方法： </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">box.style.setProperty(<span class="string">'font-size'</span>, <span class="string">'1.5em'</span>);</span><br><span class="line">box.style.item(<span class="number">0</span>) <span class="comment">// "font-size"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">document</span>.body.style.removeProperty(<span class="string">'font-size'</span>);</span><br><span class="line"><span class="built_in">document</span>.body.style.item(<span class="number">0</span>); <span class="comment">// ""</span></span><br></pre></td></tr></table></figure>
<iframe height="465" style="width: 100%;" scrolling="no" title="Using the removeProperty() method of the CSSStyleDeclaration API" src="//codepen.io/zhehuaxuan/embed/wNJOEV/?height=265&theme-id=dark&default-tab=html,result" frameborder="no" allowtransparency="true" allowfullscreen="true"><br>  See the Pen <a href="https://codepen.io/zhehuaxuan/pen/wNJOEV/" target="_blank" rel="noopener">Using the removeProperty() method of the CSSStyleDeclaration API</a> by 宣浙华<br>  (<a href="https://codepen.io/zhehuaxuan" target="_blank" rel="noopener">@zhehuaxuan</a>) on <a href="https://codepen.io" target="_blank" rel="noopener">CodePen</a>.<br></iframe>

<p>In this case, after I set <code>font-size</code> using <code>setProperty()</code>, I log the property name to ensure it’s there. The demo then includes a button that, when clicked, will remove the property using <code>removeProperty()</code>.</p>
<p>在这种例子中，我们使用<code>setProperty()</code>设置<code>font-size</code>之后，我记录属性名称，然后使用一个按钮，单击该按钮使用<code>removeProperty()</code>删除该属性。 </p>
<h3 id="获取和设置属性的优先级"><a href="#获取和设置属性的优先级" class="headerlink" title="#获取和设置属性的优先级"></a><a href="https://css-tricks.com/an-introduction-and-guide-to-the-css-object-model-cssom/#article-header-id-7" target="_blank" rel="noopener">#</a>获取和设置属性的优先级</h3><p>最后，这是我在写这篇文章的时候发现了一个有趣的特性：使用<code>getPropertyPriority()</code>，看下面CodePen演示的示例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">box.style.setProperty(<span class="string">'font-family'</span>, <span class="string">'Georgia, serif'</span>, <span class="string">'important'</span>);</span><br><span class="line">box.style.setProperty(<span class="string">'font-size'</span>, <span class="string">'1.5em'</span>);</span><br><span class="line"></span><br><span class="line">box.style.getPropertyPriority(<span class="string">'font-family'</span>); <span class="comment">// important</span></span><br><span class="line">op2.innerHTML = box.style.getPropertyPriority(<span class="string">'font-size'</span>); <span class="comment">// ""</span></span><br></pre></td></tr></table></figure>
<iframe height="465" style="width: 100%;" scrolling="no" title="Using getPropertyPriority() to get a property&apos;s &amp;quot;importance&amp;quot;" src="//codepen.io/zhehuaxuan/embed/wNJOLv/?height=265&theme-id=dark&default-tab=html,result" frameborder="no" allowtransparency="true" allowfullscreen="true"><br>  See the Pen <a href="https://codepen.io/zhehuaxuan/pen/wNJOLv/" target="_blank" rel="noopener">Using getPropertyPriority() to get a property&apos;s &amp;quot;importance&amp;quot;</a> by 宣浙华<br>  (<a href="https://codepen.io/zhehuaxuan" target="_blank" rel="noopener">@zhehuaxuan</a>) on <a href="https://codepen.io" target="_blank" rel="noopener">CodePen</a>.<br></iframe>

<p>在该代码的第一行，您可以看到我使用<code>setProperty()</code>方法，就像我之前一样。但是，我们在这里包含了第三个参数。第三个参数是一个可选字符串，用于定义是否希望该属性附加<code>!important</code>关键字。</p>
<p>在我为属性设置<code>!important</code>之后，我们使用<code>getPropertyPriority()</code>方法检查该属性的优先级。如果您觉得该属性不重要，可以省略第三个参数，使用关键字<code>undefined</code>，或将第三个参数包含为空字符串。</p>
<p>我应该在这里强调，这些方法可以与已经直接放在HTML元素<code>style</code>属性上的任何内联样式一起使用。</p>
<p>所以，如果我有如下HTML：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box"</span> <span class="attr">style</span>=<span class="string">"border: solid 1px red !important;"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>我可以使用本节中讨论的任何方法来读取或修改该样式。这里应该注意的是，由于我使用了这种内联样式的简写属性并将其设置为<code>!important</code>，因此我们使用<code>getPropertyPriority()</code>就可以把长属性的<code>important</code>返回出来，请参阅下面的代码和演示： </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// These all return "important"</span></span><br><span class="line">box.style.getPropertyPriority(<span class="string">'border'</span>));</span><br><span class="line">box.style.getPropertyPriority(<span class="string">'border-top-width'</span>));</span><br><span class="line">box.style.getPropertyPriority(<span class="string">'border-bottom-width'</span>));</span><br><span class="line">box.style.getPropertyPriority(<span class="string">'border-color'</span>));</span><br><span class="line">box.style.getPropertyPriority(<span class="string">'border-style'</span>));</span><br></pre></td></tr></table></figure>
<iframe height="465" style="width: 100%;" scrolling="no" title="Using getPropertyPriority() to check the priority of longhand properties" src="//codepen.io/zhehuaxuan/embed/xMqeZz/?height=265&theme-id=dark&default-tab=html,result" frameborder="no" allowtransparency="true" allowfullscreen="true"><br>  See the Pen <a href="https://codepen.io/zhehuaxuan/pen/xMqeZz/" target="_blank" rel="noopener">Using getPropertyPriority() to check the priority of longhand properties</a> by 宣浙华<br>  (<a href="https://codepen.io/zhehuaxuan" target="_blank" rel="noopener">@zhehuaxuan</a>) on <a href="https://codepen.io" target="_blank" rel="noopener">CodePen</a>.<br></iframe>

<p>在这个例子中，即使我只在<code>border</code>属性中显式设置了<code>style</code>属性的<code>important</code>，所有关联<code>border</code>的长属性也都返回<code>important</code>。 </p>
<h3 id="CSS样式表API"><a href="#CSS样式表API" class="headerlink" title="# CSS样式表API"></a><a href="https://css-tricks.com/an-introduction-and-guide-to-the-css-object-model-cssom/#article-header-id-8" target="_blank" rel="noopener">#</a> CSS样式表API</h3><p>到目前为止，我所考虑的方法都涉及内联样式（通常不那么有用）和计算样式（这些方式很有用，但通常过于具体）。</p>
<p>还有一个更有用的API，允许您获取具有可读写性的样式表，而不仅仅是内联样式，这就是<code>CSS</code>样式表。从文档样式表访问文档属性的最简单方法是使用<code>styleSheets</code>属性。这就是<code>CSS</code>样式表API。</p>
<p>例如，下面的使用该<code>length</code>属性来查看当前文档具有多少个样式表：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.styleSheets.length; <span class="comment">// 1</span></span><br></pre></td></tr></table></figure>
<p>我可以使用从零开始的索引来引用任何文档的样式表： </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.styleSheets[<span class="number">0</span>];</span><br></pre></td></tr></table></figure>
<p>如果我们用console打印stylesheet ，我们将会看到下面的这些方法和属性：</p>
<p><img src="https://css-tricks.com/wp-content/uploads/2018/11/docstylesheet.png" alt="The CSSStyleSheet Interface in the DevTools Console"></p>
<p>这里最有用的属性是<code>cssRules</code>。此属性提供样式表中包含的所有CSS规则（包括声明块，规则，媒体规则等）。在下面，我将详细介绍如何利用此API来操作和读取外部样式表中的样式。 </p>
<h3 id="使用样式表对象"><a href="#使用样式表对象" class="headerlink" title="#使用样式表对象"></a><a href="https://css-tricks.com/an-introduction-and-guide-to-the-css-object-model-cssom/#article-header-id-9" target="_blank" rel="noopener">#</a>使用样式表对象</h3><p>为了简单起见，让我们使用外部样式表，其中只包含少量规则。这里请允许我演示如何使用CSSOM访问样式表的不同部分，和DOM脚本的方式类似。</p>
<p>这是我使用下面的样式表：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">* &#123;</span><br><span class="line">  <span class="attribute">box-sizing</span>: border-box;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">  <span class="attribute">font-family</span>: Helvetica, Arial, sans-serif;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">2em</span>;</span><br><span class="line">  <span class="attribute">line-height</span>: <span class="number">1.4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">main</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">1024px</span>;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span> auto <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.component</span> &#123;</span><br><span class="line">  <span class="attribute">float</span>: right;</span><br><span class="line">  <span class="attribute">border-left</span>: solid <span class="number">1px</span> <span class="number">#444</span>;</span><br><span class="line">  <span class="attribute">margin-left</span>: <span class="number">20px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@<span class="keyword">media</span> (max-width: <span class="number">800px</span>) &#123;</span><br><span class="line">  <span class="selector-tag">body</span> &#123;</span><br><span class="line">    <span class="attribute">line-height</span>: <span class="number">1.2</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.component</span> &#123;</span><br><span class="line">    <span class="attribute">float</span>: none;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">a</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: lightgreen;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@<span class="keyword">keyframes</span> exampleAnimation &#123;</span><br><span class="line">  <span class="selector-tag">from</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: blue;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  20% &#123;</span><br><span class="line">    <span class="attribute">color</span>: orange;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="selector-tag">to</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: green;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">code</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: firebrick;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我可以在这个例子中尝试很多事情，首先，我将循环遍历样式表中的所有样式规则，并记录每个样式的选择器的值： </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> myRules = <span class="built_in">document</span>.styleSheets[<span class="number">0</span>].cssRules,</span><br><span class="line">p = <span class="built_in">document</span>.querySelector(<span class="string">'p'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i <span class="keyword">of</span> myRules) &#123;</span><br><span class="line">  <span class="keyword">if</span> (i.type === <span class="number">1</span>) &#123;</span><br><span class="line">    p.innerHTML += <span class="string">`&lt;code&gt;<span class="subst">$&#123;i.selectorText&#125;</span>&lt;/code&gt;&lt;br&gt;`</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<iframe height="465" style="width: 100%;" scrolling="no" title="davLKB" src="//codepen.io/zhehuaxuan/embed/davLKB/?height=465&theme-id=dark&default-tab=css,result" frameborder="no" allowtransparency="true" allowfullscreen="true"><br>  See the Pen <a href="https://codepen.io/zhehuaxuan/pen/davLKB/" target="_blank" rel="noopener">davLKB</a> by 宣浙华<br>  (<a href="https://codepen.io/zhehuaxuan" target="_blank" rel="noopener">@zhehuaxuan</a>) on <a href="https://codepen.io" target="_blank" rel="noopener">CodePen</a>.<br></iframe>

<p>在上面的示例中需要注意的几件事情。首先，我定义记录外部样式表的<code>cssRules</code>对象的引用。然后我遍历该对象中的所有规则，检查每个规则的类型。</p>
<p>在这种情况下，我想要类型的规则<code>1</code>，它代表<code>STYLE_RULE</code>常量。其他常量包括<code>IMPORT_RULE</code>（3），<code>MEDIA_RULE</code>（4），<code>KEYFRAMES_RULE</code>（7）等。您可以<a href="https://developer.mozilla.org/en-US/docs/Web/API/CSSRule#Type_constants" target="_blank" rel="noopener">在此MDN文章中</a>查看这些常量的完整表。</p>
<p>当我确认规则是样式规则时，我打印每个样式规则的<code>selectorText</code>属性。展示如下结果：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">*</span><br><span class="line">body</span><br><span class="line">main</span><br><span class="line">.component</span><br><span class="line">a:hover</span><br><span class="line">code</span><br></pre></td></tr></table></figure>
<p><code>selectorText</code>属性表示选择器样式规则的名称。这是一个可写属性，所以如果我用<code>for</code>使用以下代码更改原始循环内特定规则的选择器： </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (i.selectorText === <span class="string">'a:hover'</span>) &#123;</span><br><span class="line">  i.selectorText = <span class="string">'a:hover, a:active'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<iframe height="465" style="width: 100%;" scrolling="no" title="Working with the CSSStyleSheet API – Changing the Selector Text" src="//codepen.io/zhehuaxuan/embed/yZMrmE/?height=265&theme-id=dark&default-tab=js,result" frameborder="no" allowtransparency="true" allowfullscreen="true"><br>  See the Pen <a href="https://codepen.io/zhehuaxuan/pen/yZMrmE/" target="_blank" rel="noopener">Working with the CSSStyleSheet API – Changing the Selector Text</a> by 宣浙华<br>  (<a href="https://codepen.io/zhehuaxuan" target="_blank" rel="noopener">@zhehuaxuan</a>) on <a href="https://codepen.io" target="_blank" rel="noopener">CodePen</a>.<br></iframe>

<p>在这个例子中，我查询一个选择器（链接），把 <code>:hover</code> 属性查询出来，应用到 <code>:active</code> 中。而且，我可以使用字符串方法甚至是正则表达式来查找所有实例的<code>:hover</code>，然后从那里做一些事情。但这个例子已经足以证明它的工作原理。 </p>
<h3 id="使用CSSOM访问-media规则"><a href="#使用CSSOM访问-media规则" class="headerlink" title="#使用CSSOM访问@media规则"></a><a href="https://css-tricks.com/an-introduction-and-guide-to-the-css-object-model-cssom/#article-header-id-10" target="_blank" rel="noopener">#</a>使用CSSOM访问@media规则</h3><p>您会注意到我的样式表还包括媒体查询规则：@keyframes at-rule。当我搜索样式规则（类型1）时，这两个都被跳过了。我们现在找到所有<code>@media</code>规则： </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> myRules = <span class="built_in">document</span>.styleSheets[<span class="number">0</span>].cssRules,</span><br><span class="line">p = <span class="built_in">document</span>.querySelector(<span class="string">'.output'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i <span class="keyword">of</span> myRules) &#123;</span><br><span class="line">  <span class="keyword">if</span> (i.type === <span class="number">4</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (j <span class="keyword">of</span> i.cssRules) &#123;</span><br><span class="line">      p.innerHTML += <span class="string">`&lt;code&gt;<span class="subst">$&#123;j.selectorText&#125;</span>&lt;/code&gt;&lt;br&gt;`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>基于给定的样式表，上面将产生： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">body</span><br><span class="line">.component</span><br></pre></td></tr></table></figure>
<iframe height="465" style="width: 100%;" scrolling="no" title="Working with the CSSStyleSheet API – Accessing @media Rules" src="//codepen.io/zhehuaxuan/embed/MLpdJz/?height=465&theme-id=dark&default-tab=css,result" frameborder="no" allowtransparency="true" allowfullscreen="true"><br>  See the Pen <a href="https://codepen.io/zhehuaxuan/pen/MLpdJz/" target="_blank" rel="noopener">Working with the CSSStyleSheet API – Accessing @media Rules</a> by 宣浙华<br>  (<a href="https://codepen.io/zhehuaxuan" target="_blank" rel="noopener">@zhehuaxuan</a>) on <a href="https://codepen.io" target="_blank" rel="noopener">CodePen</a>.<br></iframe>

<p>正如您所看到的，在我遍历所有规则以查看是否存在<code>@media</code>规则（类型4）之后，我遍历<code>cssRules</code>的每个媒体规则对象（在这种情况下，只有一个）并记录在那个媒体规则里面的每个规则的选择器文本。</p>
<p>因此，<code>@media</code>规则上公开的接口类似于样式表上公开的接口。<code>@media</code>中的规则还包含一个<code>conditionText</code>属性，如以下代码段和演示中所示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> myRules = <span class="built_in">document</span>.styleSheets[<span class="number">0</span>].cssRules,</span><br><span class="line">p = <span class="built_in">document</span>.querySelector(<span class="string">'.output'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i <span class="keyword">of</span> myRules) &#123;</span><br><span class="line">  <span class="keyword">if</span> (i.type === <span class="number">4</span>) &#123;</span><br><span class="line">    p.innerHTML += <span class="string">`&lt;code&gt;<span class="subst">$&#123;i.conditionText&#125;</span>&lt;/code&gt;&lt;br&gt;`</span>;</span><br><span class="line">    <span class="comment">// (max-width: 800px) </span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<iframe height="465" style="width: 100%;" scrolling="no" title="Working with the CSSStyleSheet API – Accessing @media Rules" src="//codepen.io/zhehuaxuan/embed/OdmOwd/?height=465&theme-id=dark&default-tab=css,result" frameborder="no" allowtransparency="true" allowfullscreen="true"><br>  See the Pen <a href="https://codepen.io/zhehuaxuan/pen/OdmOwd/" target="_blank" rel="noopener">Working with the CSSStyleSheet API – Accessing @media Rules</a> by 宣浙华<br>  (<a href="https://codepen.io/zhehuaxuan" target="_blank" rel="noopener">@zhehuaxuan</a>) on <a href="https://codepen.io" target="_blank" rel="noopener">CodePen</a>.<br></iframe>

<p>此代码循环遍历所有媒体查询规则，并记录确定该规则何时适用的文本（即条件）。还有一个<code>mediaText</code>返回相同值的属性。根据规范，您可以获得或设置其中任何一个。 </p>
<h3 id="使用CSSOM访问-keyframes规则"><a href="#使用CSSOM访问-keyframes规则" class="headerlink" title="#使用CSSOM访问@keyframes规则"></a><a href="https://css-tricks.com/an-introduction-and-guide-to-the-css-object-model-cssom/#article-header-id-11" target="_blank" rel="noopener">#</a>使用CSSOM访问@keyframes规则</h3><p>上述我已经演示了如何读取<code>@media</code>规则中的信息，现在让我们考虑如何访问<code>@keyframes</code>规则。我们从下面的代码开始： </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> myRules = <span class="built_in">document</span>.styleSheets[<span class="number">0</span>].cssRules,</span><br><span class="line">p = <span class="built_in">document</span>.querySelector(<span class="string">'.output'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i <span class="keyword">of</span> myRules) &#123;</span><br><span class="line">  <span class="keyword">if</span> (i.type === <span class="number">7</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (j <span class="keyword">of</span> i.cssRules) &#123;</span><br><span class="line">     p.innerHTML += <span class="string">`&lt;code&gt;<span class="subst">$&#123;j.keyText&#125;</span>&lt;/code&gt;&lt;br&gt;`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<iframe height="465" style="width: 100%;" scrolling="no" title="Working with the CSSStyleSheet API – Accessing @keyframes Rules" src="//codepen.io/zhehuaxuan/embed/mvmqzz/?height=465&theme-id=dark&default-tab=css,result" frameborder="no" allowtransparency="true" allowfullscreen="true"><br>  See the Pen <a href="https://codepen.io/zhehuaxuan/pen/mvmqzz/" target="_blank" rel="noopener">Working with the CSSStyleSheet API – Accessing @keyframes Rules</a> by 宣浙华<br>  (<a href="https://codepen.io/zhehuaxuan" target="_blank" rel="noopener">@zhehuaxuan</a>) on <a href="https://codepen.io" target="_blank" rel="noopener">CodePen</a>.<br></iframe>

<p>在这个例子中，我正在查询类型为7（i.e. <code>@keyframes</code>规则）的规则。当找到一个规则时，遍历所有规则<code>cssRules</code>并记录每个规则的<code>keyText</code>属性。这种情况下的日志将是： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;0%&quot;</span><br><span class="line">&quot;20%&quot;</span><br><span class="line">&quot;100%&quot;</span><br></pre></td></tr></table></figure>
<p>您会注意到我的原始CSS使用<code>from</code>并<code>to</code>作为第一个和最后一个关键帧，但是<code>keyText</code>属性计算这些<code>0%</code>和<code>100%</code>。<code>keyText</code>也可以设置值。在我的示例样式表中，我可以像这样硬编码： </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Read the current value (0%)</span></span><br><span class="line"><span class="built_in">document</span>.styleSheets[<span class="number">0</span>].cssRules[<span class="number">6</span>].cssRules[<span class="number">0</span>].keyText;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Change the value to 10%</span></span><br><span class="line"><span class="built_in">document</span>.styleSheets[<span class="number">0</span>].cssRules[<span class="number">6</span>].cssRules[<span class="number">0</span>].keyText = <span class="string">'10%'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Read the new value (10%)</span></span><br><span class="line"><span class="built_in">document</span>.styleSheets[<span class="number">0</span>].cssRules[<span class="number">6</span>].cssRules[<span class="number">0</span>].keyText;</span><br></pre></td></tr></table></figure>
<iframe height="465" style="width: 100%;" scrolling="no" title="Working with the CSSStyleSheet API – Setting @keyframes Rules" src="//codepen.io/zhehuaxuan/embed/jdmaRP/?height=465&theme-id=dark&default-tab=js,result" frameborder="no" allowtransparency="true" allowfullscreen="true"><br>  See the Pen <a href="https://codepen.io/zhehuaxuan/pen/jdmaRP/" target="_blank" rel="noopener">Working with the CSSStyleSheet API – Setting @keyframes Rules</a> by 宣浙华<br>  (<a href="https://codepen.io/zhehuaxuan" target="_blank" rel="noopener">@zhehuaxuan</a>) on <a href="https://codepen.io" target="_blank" rel="noopener">CodePen</a>.<br></iframe>

<p>使用此功能，我们可以动态更改Web应用程序流中的动画关键帧，也可以响应用户操作。</p>
<p>访问<code>@keyframes</code>规则时可用的另一个属性是<code>name</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> myRules = <span class="built_in">document</span>.styleSheets[<span class="number">0</span>].cssRules,</span><br><span class="line">    p = <span class="built_in">document</span>.querySelector(<span class="string">'.output'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i <span class="keyword">of</span> myRules) &#123;</span><br><span class="line">  <span class="keyword">if</span> (i.type === <span class="number">7</span>) &#123;</span><br><span class="line">    p.innerHTML += <span class="string">`&lt;code&gt;<span class="subst">$&#123;i.name&#125;</span>&lt;/code&gt;&lt;br&gt;`</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<iframe height="465" style="width: 100%;" scrolling="no" title="Working with the CSSStyleSheet API – Getting the name of a @keyframes rule" src="//codepen.io/zhehuaxuan/embed/JxNOQM/?height=465&theme-id=dark&default-tab=css,result" frameborder="no" allowtransparency="true" allowfullscreen="true"><br>  See the Pen <a href="https://codepen.io/zhehuaxuan/pen/JxNOQM/" target="_blank" rel="noopener">Working with the CSSStyleSheet API – Getting the name of a @keyframes rule</a> by 宣浙华<br>  (<a href="https://codepen.io/zhehuaxuan" target="_blank" rel="noopener">@zhehuaxuan</a>) on <a href="https://codepen.io" target="_blank" rel="noopener">CodePen</a>.<br></iframe>

<p>回想一下，在CSS中，<code>@keyframes</code>规则如下所示： </p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@<span class="keyword">keyframes</span> exampleAnimation &#123;</span><br><span class="line">  <span class="selector-tag">from</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: blue;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  20% &#123;</span><br><span class="line">    <span class="attribute">color</span>: orange;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="selector-tag">to</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: green;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此，<code>name</code>属性允许我读取以<code>@keyframes</code>和自定义名称该规则。<code>animation-name</code>特定元素上启用动画时在属性中使用的名称相同。</p>
<p>我在这里要提到的最后一件事是能够获取单个关键帧内的特定样式。这是一些带有演示的示例代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> myRules = <span class="built_in">document</span>.styleSheets[<span class="number">0</span>].cssRules,</span><br><span class="line">    p = <span class="built_in">document</span>.querySelector(<span class="string">'.output'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i <span class="keyword">of</span> myRules) &#123;</span><br><span class="line">  <span class="keyword">if</span> (i.type === <span class="number">7</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (j <span class="keyword">of</span> i.cssRules) &#123;</span><br><span class="line">      p.innerHTML += <span class="string">`&lt;code&gt;<span class="subst">$&#123;j.style.color&#125;</span>&lt;/code&gt;&lt;br&gt;`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<iframe height="465" style="width: 100%;" scrolling="no" title="Working with the CSSStyleSheet API – Accessing Property Values inside @keyframes Rules" src="//codepen.io/zhehuaxuan/embed/WPjdrQ/?height=465&theme-id=dark&default-tab=css,result" frameborder="no" allowtransparency="true" allowfullscreen="true"><br>  See the Pen <a href="https://codepen.io/zhehuaxuan/pen/WPjdrQ/" target="_blank" rel="noopener">Working with the CSSStyleSheet API – Accessing Property Values inside @keyframes Rules</a> by 宣浙华<br>  (<a href="https://codepen.io/zhehuaxuan" target="_blank" rel="noopener">@zhehuaxuan</a>) on <a href="https://codepen.io" target="_blank" rel="noopener">CodePen</a>.<br></iframe>

<p>在这个例子中，在我找到<code>@keyframes</code>规则之后，我遍历关键帧中的每个规则（例如“from”规则，“20％”规则等）。然后，在每个规则中，我访问一个单独的<code>style</code>属性。在这种情况下，因为我知道<code>color</code>是在@keyframes定义的唯一属性。</p>
<p>这个例子的主要内容是使用<code>style</code>属性或对象。之前我展示了如何使用此属性来访问内联样式。但在这种情况下，我使用它来访问单个关键帧内的各个属性。</p>
<p>你可能会看到这允许您动态修改单个关键帧的属性，这可能会由于某些用户操作或应用程序或基于Web的游戏中发生的事件而发生改动。</p>
<h3 id="添加和删除CSS声明"><a href="#添加和删除CSS声明" class="headerlink" title="#添加和删除CSS声明"></a><a href="https://css-tricks.com/an-introduction-and-guide-to-the-css-object-model-cssom/#article-header-id-12" target="_blank" rel="noopener">#</a>添加和删除CSS声明</h3><p><code>CSSStyleSheet</code>可以访问两种方法，允许您从样式表中添加或删除整个规则：<code>insertRule()</code>和<code>deleteRule()</code>。让我们看看在示例中，他们两个如何操作样式表： </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> myStylesheet = <span class="built_in">document</span>.styleSheets[<span class="number">0</span>];</span><br><span class="line"><span class="built_in">console</span>.log(myStylesheet.cssRules.length); <span class="comment">// 8</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">document</span>.styleSheets[<span class="number">0</span>].insertRule(<span class="string">'article &#123; line-height: 1.5; font-size: 1.5em; &#125;'</span>, myStylesheet.cssRules.length);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">document</span>.styleSheets[<span class="number">0</span>].cssRules.length); <span class="comment">// 9</span></span><br></pre></td></tr></table></figure>
<iframe height="465" style="width: 100%;" scrolling="no" title="qgmpay" src="//codepen.io/zhehuaxuan/embed/qgmpay/?height=465&theme-id=dark&default-tab=css,result" frameborder="no" allowtransparency="true" allowfullscreen="true"><br>  See the Pen <a href="https://codepen.io/zhehuaxuan/pen/qgmpay/" target="_blank" rel="noopener">qgmpay</a> by 宣浙华<br>  (<a href="https://codepen.io/zhehuaxuan" target="_blank" rel="noopener">@zhehuaxuan</a>) on <a href="https://codepen.io" target="_blank" rel="noopener">CodePen</a>.<br></iframe>

<p>在这种情况下，我正在记录<code>cssRules</code>属性的长度（显示样式表最初有8个规则），然后我使用以下<code>insertRule()</code>方法将以下CSS添加为单独的规则： </p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">article</span> &#123;</span><br><span class="line">  <span class="attribute">line-height</span>: <span class="number">1.5</span>;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">1.5em</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我<code>cssRules</code>再次记录属性的长度以确认添加了规则。</p>
<p>该<code>insertRule()</code>方法将字符串作为第一个参数（这是必需的），该参数包括待插入的完整样式规则（包括选择器，花括号等），包括嵌套在at规则中的各个规则可以包含在此字符串中。</p>
<p>第二个参数是可选的。这是一个整数，表示您希望插入规则的位置或索引。如果未包括，则默认为<code>0</code>（意味着规则将插入规则集合的开头）。如果索引恰好大于规则对象的长度，则会引发错误。</p>
<p>该<code>deleteRule()</code>方法使用起来更简单：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> myStylesheet = <span class="built_in">document</span>.styleSheets[<span class="number">0</span>];</span><br><span class="line"><span class="built_in">console</span>.log(myStylesheet.cssRules.length); <span class="comment">// 8</span></span><br><span class="line"></span><br><span class="line">myStylesheet.deleteRule(<span class="number">3</span>);</span><br><span class="line"><span class="built_in">console</span>.log(myStylesheet.cssRules.length); <span class="comment">// 7</span></span><br></pre></td></tr></table></figure>
<iframe height="465" style="width: 100%;" scrolling="no" title="Working with the CSSStyleSheet API – Deleting Rules" src="//codepen.io/zhehuaxuan/embed/WPjdWj/?height=465&theme-id=dark&default-tab=css,result" frameborder="no" allowtransparency="true" allowfullscreen="true"><br>  See the Pen <a href="https://codepen.io/zhehuaxuan/pen/WPjdWj/" target="_blank" rel="noopener">Working with the CSSStyleSheet API – Deleting Rules</a> by 宣浙华<br>  (<a href="https://codepen.io/zhehuaxuan" target="_blank" rel="noopener">@zhehuaxuan</a>) on <a href="https://codepen.io" target="_blank" rel="noopener">CodePen</a>.<br></iframe>

<p>在这个例子中，这个方法接受一个参数，该参数表示我要删除的规则的索引。</p>
<p>使用任一方法，由于基于零的索引，作为参数传入的选定索引必须小于<code>cssRules</code>对象的长度，否则将引发错误。</p>
<h3 id="重新访问-CSS样式声明-API"><a href="#重新访问-CSS样式声明-API" class="headerlink" title="#重新访问 CSS样式声明 API"></a><a href="https://css-tricks.com/an-introduction-and-guide-to-the-css-object-model-cssom/#article-header-id-13" target="_blank" rel="noopener">#</a>重新访问 CSS样式声明 API</h3><p>之前我解释了如何访问声明为内联样式的单个属性和值。这是通过<code>element.style</code>，暴露<code>CSS</code>样式声明接口完成的。</p>
<p><code>CSSS</code>样式声明API作为<code>CSS</code>样式表API的子集暴露一个单独的样式规则，当我向您展示如何访问<code>@keyframes</code>规则内的属性时，我已经提到了这一点。要了解其工作原理，请比较以下两个代码段：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"color: lightblue; width: 100px; font-size: 1.3em !important;"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.box</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: lightblue;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100px</span>;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">1.3em</span> <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第一个例子是获取内联样式的集合如下所示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.querySelector(<span class="string">'div'</span>).style</span><br></pre></td></tr></table></figure>
<p><code>CSS</code>样式声明API，允许我获取<code>element.style.color</code>，<code>element.style.width</code>等属性对象。</p>
<p>但我可以在外部样式表中的单个样式规则上公开完全相同的API。这意味着我将我对<code>style</code>属性的使用与<code>CSS</code>样式表API结合起来。</p>
<p>因此，上面第二个示例中的CSS使用与内联版本完全相同的样式，可以像这样访问：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.styleSheets[<span class="number">0</span>].cssRules[<span class="number">0</span>].style</span><br></pre></td></tr></table></figure>
<p>这里打开一个外链样式表的一个样式规则的<code>CSS</code>样式声明对象，如果有多个样式规则，可以使用<code>cssRules[1]</code>, <code>cssRules[2]</code>, <code>cssRules[3]</code>等方式来获取。</p>
<p>因此，在外部样式表中，我可以访问前面提到的所有方法和属性。这包括<code>SetProperty()，getPropertyValue()，item()，removeProperty()</code>和<code>getPropertyPriority()</code>。除此之外，这些相同的功能可用于@keyframes或@media规则内的单个样式规则。</p>
<p>这是一个代码片段和演示，演示了如何在我们的示例样式表中的单个样式规则上使用这些方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Grab the style rules for the body and main elements</span></span><br><span class="line"><span class="keyword">let</span> myBodyRule = <span class="built_in">document</span>.styleSheets[<span class="number">0</span>].cssRules[<span class="number">1</span>].style,</span><br><span class="line">    myMainRule = <span class="built_in">document</span>.styleSheets[<span class="number">0</span>].cssRules[<span class="number">2</span>].style;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set the bg color on the body</span></span><br><span class="line">myBodyRule.setProperty(<span class="string">'background-color'</span>, <span class="string">'peachpuff'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get the font size of the body</span></span><br><span class="line">myBodyRule.getPropertyValue(<span class="string">'font-size'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get the 5th item in the body's style rule</span></span><br><span class="line">myBodyRule.item(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Log the current length of the body style rule (8)</span></span><br><span class="line">myBodyRule.length;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Remove the line height</span></span><br><span class="line">myBodyRule.removeProperty(<span class="string">'line-height'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// log the length again (7)</span></span><br><span class="line">myBodyRule.length;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check priority of font-family (empty string)</span></span><br><span class="line">myBodyRule.getPropertyPriority(<span class="string">'font-family'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check priority of margin in the "main" style rule (!important)</span></span><br><span class="line">myMainRule.getPropertyPriority(<span class="string">'margin'</span>);</span><br></pre></td></tr></table></figure>
<iframe height="465" style="width: 100%;" scrolling="no" title="Working with the style object of an individual style rule in an external Stylesheet" src="//codepen.io/zhehuaxuan/embed/vbmdGL/?height=465&theme-id=dark&default-tab=js,result" frameborder="no" allowtransparency="true" allowfullscreen="true"></iframe>

<h3 id="CSS类型对象模型…未来？"><a href="#CSS类型对象模型…未来？" class="headerlink" title="#CSS类型对象模型…未来？"></a><a href="https://css-tricks.com/an-introduction-and-guide-to-the-css-object-model-cssom/#article-header-id-14" target="_blank" rel="noopener">#</a>CSS类型对象模型…未来？</h3><p>在上面提过的所有内容之后，我不得不说在将来的某一天，我们所知道的CSSOM很可能也会过时。</p>
<p>那是因为有一个被称为<a href="https://drafts.css-houdini.org/css-typed-om/" target="_blank" rel="noopener">CSS Typed OM</a>的出现，它是<a href="https://drafts.css-houdini.org/" target="_blank" rel="noopener">Houdini项目的</a>一部分。虽然有些人已经注意到新的Typed OM与目前的CSSOM相比更加冗长，但<a href="https://developers.google.com/web/updates/2018/03/cssom" target="_blank" rel="noopener">Eric Bidelman在本文中</a>概述的好处包括： </p>
<ul>
<li>更少的错误</li>
<li>算术运算和单位转换</li>
<li>更好的性能</li>
<li>错误处理</li>
<li>CSS属性名称始终是字符串</li>
</ul>
<p>有关这些功能的完整详细信息和语法的一瞥，请务必查看<a href="https://developers.google.com/web/updates/2018/03/cssom" target="_blank" rel="noopener">完整的文章</a>。</p>
<p>在撰写本文时，CSS Typed OM仅在Chrome中受支持。您可以<a href="https://www.chromestatus.com/feature/5682491075592192" target="_blank" rel="noopener">在本文档中</a>查看浏览器支持的进度。</p>
<h3 id="最后小结"><a href="#最后小结" class="headerlink" title="#最后小结"></a><a href="https://css-tricks.com/an-introduction-and-guide-to-the-css-object-model-cssom/#article-header-id-15" target="_blank" rel="noopener">#</a>最后小结</h3><p>通过JavaScript操作样式表肯定不是你在每个项目中都要做的事情。使用我在这里介绍的方法和属性实现的一些复杂交互有一些非常具体的用例。</p>
<p>如果您已经构建了某种使用这些API的工具，<a href="https://webtoolsweekly.com/?view=suggest" target="_blank" rel="noopener">我很乐意听到它</a>。我的研究只是触及了表面上的东西，但我很想知道在现实世界的例子中如何使用它。</p>
<p>我已将本文中的所有演示文稿<a href="https://codepen.io/collection/DEmrVv/" target="_blank" rel="noopener">放入CodePen集合中</a>，因此您可以根据自己的喜好随意使用它们。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhehuaxuan.github.io/2019/03/03/2019年写作计划/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZheHuaXuan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhehua's note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/03/2019年写作计划/" itemprop="url">2019年写作计划</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-03T10:48:20+08:00">
                2019-03-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><p>记录2019年写作计划。</p>
<h2 id="计划"><a href="#计划" class="headerlink" title="计划"></a>计划</h2><p>2019年2月</p>
<ol>
<li><a href="https://zhehuaxuan.github.io/2019/02/21/JavaScript%E6%96%B0%E5%BB%BA%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%A8%A1%E6%8B%9F/">JavaScript新建对象的模拟</a></li>
<li><a href="https://zhehuaxuan.github.io/2019/02/26/JavaScript%E8%BF%9B%E9%98%B6%E4%B9%8B%E6%A8%A1%E6%8B%9Fcall%E5%92%8Capply/">JavaScript进阶之模拟call和apply</a></li>
</ol>
<p>2019年3月</p>
<ol>
<li><a href="https://zhehuaxuan.github.io/2019/02/13/translation/CSSOM/">[译]CSS对象模型（CSSOM）指南</a></li>
<li>跟underscore一起学如何写函数库</li>
<li>underscore之函数去重的姿势</li>
<li>模拟Vue的MVVM</li>
<li>[译]xxxx</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhehuaxuan.github.io/2019/02/28/数组的去重/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZheHuaXuan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhehua's note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/28/数组的去重/" itemprop="url">JavaScript进阶系列之数组的去重</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-28T01:08:20+08:00">
                2019-02-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript进阶系列/" itemprop="url" rel="index">
                    <span itemprop="name">JavaScript进阶系列</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="引子"><a href="#引子" class="headerlink" title="引子"></a>引子</h2><p>数组的去重是一个老生常谈的话题，在面试中也经常会被问道。我们使用如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var a = [1,1,2,3,4,4];</span><br><span class="line">var res = [...new Set(a)];</span><br></pre></td></tr></table></figure>
<p>这应该是JavaScript中最简洁的去重方法了。我们在这里当然不是想证明我们的API的高级调用者。</p>
<p>这边文章我们就是要一起讨论一下我们是怎么通过数据结构去实现高效的去重的，或者研究JavaScript的一些库（underscore）内部是如何来去重的。</p>
<p>## </p>
<h2 id="我们还能怎么做？"><a href="#我们还能怎么做？" class="headerlink" title="我们还能怎么做？"></a>我们还能怎么做？</h2>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhehuaxuan.github.io/2019/02/26/JavaScript进阶之模拟call和apply/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZheHuaXuan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhehua's note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/26/JavaScript进阶之模拟call和apply/" itemprop="url">JavaScript进阶之模拟call,apply和bind</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-26T20:08:03+08:00">
                2019-02-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript进阶系列/" itemprop="url" rel="index">
                    <span itemprop="name">JavaScript进阶系列</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>本文主要用于理解和掌握<code>call</code>，<code>apply</code>和<code>bind</code>的使用和原理，本文适用于对它们的用法不是很熟悉，或者想搞清楚它们原理的童鞋。好，那我们开始！<br>在JavaScript中有三种方式来改变<code>this</code>的作用域<code>call</code>，<code>apply</code>和<code>bind</code>。我们先来看看它们是怎么用的，只有知道怎么用的，我们才能来模拟它😸。</p>
<h2 id="Function-prototype-call"><a href="#Function-prototype-call" class="headerlink" title="Function.prototype.call()"></a>Function.prototype.call()</h2><p>首先是<code>Function.prototype.call()</code>，不熟的童鞋请猛戳<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function/call" target="_blank" rel="noopener">MDN</a>，它是这么说的：<strong><code>call()</code>允许为不同的对象分配和调用属于一个对象的函数/方法</strong>。也就是说：一个函数，只要调用<code>call()</code>方法，就可以把它分配给不同的对象。</p>
<p>如果还是不明白，不急！跟我往下看，我们先来写一个<code>call()</code>函数最简单的用法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">source</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.name); <span class="comment">//打印 xuan</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> destination = &#123;</span><br><span class="line">    name:<span class="string">"xuan"</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">console</span>.log(source.call(destination));</span><br></pre></td></tr></table></figure>
<p>上述代码会打印出<code>destination</code>的<code>name</code>属性，也就是说<code>source()</code>函数通过调用<code>call()</code>，<code>source()</code>函数中的<code>this</code>对象可以分配到<code>destination</code>对象中。类似于实现<strong>destination.source()的效果，当然前提是destination要有一个source属性</strong></p>
<p>好，现在大家应该明白<code>call()</code>的基本用法，我们再来看下面的例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">source</span>(<span class="params">age,gender</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.name);</span><br><span class="line">    <span class="built_in">console</span>.log(age);</span><br><span class="line">    <span class="built_in">console</span>.log(gender);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> destination = &#123;</span><br><span class="line">    name:<span class="string">"xuan"</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">console</span>.log(source.call(destination,<span class="number">18</span>,<span class="string">"male"</span>));</span><br></pre></td></tr></table></figure>
<p>打印效果如下：</p>
<p><img src="/2019/02/26/JavaScript进阶之模拟call和apply/image-20190223204803524.png" alt="image-20190223204803524"></p>
<p>我们可以看到可以<code>call()</code>也可以传参，而且是以<code>参数,参数,...</code>的形式传入。</p>
<p>上述我们知道<code>call()</code>的两个作用：</p>
<blockquote>
<p>1.改变this的指向</p>
<p>2.支持对函数传参</p>
</blockquote>
<p>我们看到最后还还输出一个<code>undefined</code>，说明现在调用<code>source.call(…args)</code>没有返回值。</p>
<p>我们给<code>source</code>函数添加一个返回值试一下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">source</span>(<span class="params">age,gender</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.name);</span><br><span class="line">    <span class="built_in">console</span>.log(age);</span><br><span class="line">    <span class="built_in">console</span>.log(gender);</span><br><span class="line">    <span class="comment">//添加一个返回值对象</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        age:age,</span><br><span class="line">        gender:gender,</span><br><span class="line">        name:<span class="keyword">this</span>.name</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> destination = &#123;</span><br><span class="line">    name:<span class="string">"xuan"</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">console</span>.log(source.call(destination,<span class="number">18</span>,<span class="string">"male"</span>));</span><br></pre></td></tr></table></figure>
<p>打印结果：</p>
<p><img src="/2019/02/26/JavaScript进阶之模拟call和apply/image-20190223205338670.png" alt="image-20190223205338670"></p>
<p>果不其然！<code>call()</code>函数的返回值就是<code>source</code>函数的返回值，那么<code>call()</code>函数的作用已经很明显了。</p>
<p>这边再总结一下：</p>
<blockquote>
<ol>
<li>改变this的指向</li>
<li>支持对函数传参</li>
<li>函数返回什么，call就返回什么。</li>
</ol>
</blockquote>
<h2 id="模拟Function-prototype-call"><a href="#模拟Function-prototype-call" class="headerlink" title="模拟Function.prototype.call()"></a>模拟Function.prototype.call()</h2><p>根据<code>call()</code>函数的作用，我们下面一步一步的进行模拟。我们先把上面的部分代码摘抄下来：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">source</span>(<span class="params">age,gender</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.name);</span><br><span class="line">    <span class="built_in">console</span>.log(age);</span><br><span class="line">    <span class="built_in">console</span>.log(gender);</span><br><span class="line">    <span class="comment">//添加一个返回值对象</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        age:age,</span><br><span class="line">        gender:gender,</span><br><span class="line">        name:<span class="keyword">this</span>.name</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> destination = &#123;</span><br><span class="line">    name:<span class="string">"xuan"</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>上面的这部分代码我们先不变。现在只要实现一个函数<code>call1()</code>并使用下面方式</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(source.call1(destination));</span><br></pre></td></tr></table></figure>
<p>如果得出的结果和<code>call()</code>函数一样，那就没问题了。</p>
<p>现在我们来模拟第一步：<strong>改变this的指向</strong>。</p>
<p>假设我们destination的结构是这样的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> destination = &#123;</span><br><span class="line">    name:<span class="string">"xuan"</span>,</span><br><span class="line">    source:<span class="function"><span class="keyword">function</span>(<span class="params">age,gender</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="keyword">this</span>.name);</span><br><span class="line">        <span class="built_in">console</span>.log(age);</span><br><span class="line">        <span class="built_in">console</span>.log(gender);</span><br><span class="line">        <span class="comment">//添加一个返回值对象</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            age:age,</span><br><span class="line">            gender:gender,</span><br><span class="line">            name:<span class="keyword">this</span>.name</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们执行<code>destination.source(18,&quot;male&quot;);</code>就可以在<code>source()</code>函数中把正确的结果打印出来并且返回我们想要的值。</p>
<p>现在我们的目的更明确了：<strong>给destination对象添加一个source属性，然后添加参数执行它</strong>。</p>
<p>所以我们定义如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span>.prototype.call1 = <span class="function"><span class="keyword">function</span>(<span class="params">ctx</span>)</span>&#123;</span><br><span class="line">    ctx.fn = <span class="keyword">this</span>;   <span class="comment">//ctx为destination   this指向source   那么就是destination.fn = source;</span></span><br><span class="line">    ctx.fn(); <span class="comment">// 执行函数</span></span><br><span class="line">    <span class="keyword">delete</span> ctx.fn;  <span class="comment">//在删除这个属性</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(source.call1(destination,<span class="number">18</span>,<span class="string">"male"</span>));</span><br></pre></td></tr></table></figure>
<p>打印效果如下：</p>
<p><img src="/2019/02/26/JavaScript进阶之模拟call和apply/image-20190224111229956.png" alt="image-20190224111229956"></p>
<p>我们发现this的指向已经改变了，但是我们传入的参数还没有处理。</p>
<p>第二步：<strong>支持对函数传参</strong>。</p>
<p>我们使用ES6语法修改如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span>.prototype.call1 =<span class="function"><span class="keyword">function</span>(<span class="params">ctx,...args</span>)</span>&#123;</span><br><span class="line">    ctx.fn = <span class="keyword">this</span>;</span><br><span class="line">    ctx.fn(...args);</span><br><span class="line">    <span class="keyword">delete</span> ctx.fn;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(source.call1(destination,<span class="number">18</span>,<span class="string">"male"</span>));</span><br></pre></td></tr></table></figure>
<p>打印效果如下：</p>
<p><img src="/2019/02/26/JavaScript进阶之模拟call和apply/image-20190224111709834.png" alt="image-20190224111709834"></p>
<p>参数出现了，现在就剩下返回值了，很简单，我们再修改一下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span>.prototype.call1 =<span class="function"><span class="keyword">function</span>(<span class="params">ctx,...args</span>)</span>&#123;</span><br><span class="line">    ctx.fn = <span class="keyword">this</span> || <span class="built_in">window</span>; <span class="comment">//防止ctx为null的情况</span></span><br><span class="line">    <span class="keyword">let</span> res = ctx.fn(...args);</span><br><span class="line">    <span class="keyword">delete</span> ctx.fn;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(source.call1(destination,<span class="number">18</span>,<span class="string">"male"</span>));</span><br></pre></td></tr></table></figure>
<p>打印效果如下：</p>
<p><img src="/2019/02/26/JavaScript进阶之模拟call和apply/image-20190224111912666.png" alt="image-20190224111912666"></p>
<p>现在我们实现了<code>call</code>的效果！</p>
<h2 id="模拟Function-prototype-apply"><a href="#模拟Function-prototype-apply" class="headerlink" title="模拟Function.prototype.apply()"></a>模拟Function.prototype.apply()</h2><p><code>apply()</code>函数的作用和<code>call()</code>函数一样，只是传参的方式不一样。<code>apply</code>的用法可以查看<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function/apply" target="_blank" rel="noopener">MDN</a>，MDN这么说的：<code>apply()</code> 方法调用一个具有给定<code>this</code>值的函数，以及作为一个数组（或<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide/Indexed_collections#Working_with_array-like_objects" target="_blank" rel="noopener">类似数组对象</a>）提供的参数。</p>
<p><code>apply()</code>函数的第二个参数是一个数组，数组是调用<code>apply()</code>的函数的参数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">source</span>(<span class="params">age,gender</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.name);</span><br><span class="line">    <span class="built_in">console</span>.log(age);</span><br><span class="line">    <span class="built_in">console</span>.log(gender);</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        age:age,</span><br><span class="line">        gender:gender,</span><br><span class="line">        name:<span class="keyword">this</span>.name</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> destination = &#123;</span><br><span class="line">    name:<span class="string">"xuan"</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">console</span>.log(source.apply(destination,[<span class="number">18</span>,<span class="string">"male"</span>]));</span><br></pre></td></tr></table></figure>
<p><img src="/2019/02/26/JavaScript进阶之模拟call和apply/image-20190224135505703.png" alt="image-20190224135505703"></p>
<p>效果和<code>call()</code>是一样的。既然只是传参不一样，我们把模拟<code>call()</code>函数的代码稍微改改：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span>.prototype.apply1 =<span class="function"><span class="keyword">function</span>(<span class="params">ctx,args=[]</span>)</span>&#123;</span><br><span class="line">    ctx.fn = <span class="keyword">this</span> || <span class="built_in">window</span>;</span><br><span class="line">    <span class="keyword">let</span> res = ctx.fn(...args);</span><br><span class="line">    <span class="keyword">delete</span> ctx.fn;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(source.apply1(destination,[<span class="number">18</span>,<span class="string">'male'</span>]));</span><br></pre></td></tr></table></figure>
<p>执行效果如下：</p>
<p><img src="/2019/02/26/JavaScript进阶之模拟call和apply/image-20190224144414290.png" alt="image-20190224144414290"></p>
<p><code>apply()</code>函数的模拟完成。</p>
<h2 id="Function-prototype-bind"><a href="#Function-prototype-bind" class="headerlink" title="Function.prototype.bind()"></a>Function.prototype.bind()</h2><p>对于<code>bind()</code>函数的作用，我们引用<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function/bind" target="_blank" rel="noopener">MDN</a>，<code>bind()</code>方法会创建一个新函数。当这个新函数被调用时，<code>bind()</code> 的第一个参数将作为它运行时的 <code>this</code>对象，之后的一序列参数将会在传递的实参前传入作为它的参数。我们看一下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">source</span>(<span class="params">age,gender</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.name);</span><br><span class="line">    <span class="built_in">console</span>.log(age);</span><br><span class="line">    <span class="built_in">console</span>.log(gender);</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        age:age,</span><br><span class="line">        gender:gender,</span><br><span class="line">        name:<span class="keyword">this</span>.name</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> destination = &#123;</span><br><span class="line">    name:<span class="string">"xuan"</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> res = source.bind(destination,<span class="number">18</span>,<span class="string">"male"</span>);</span><br><span class="line"><span class="built_in">console</span>.log(res());</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"=========================="</span>)</span><br><span class="line"><span class="keyword">var</span> res1 = source.bind(destination,<span class="number">18</span>);</span><br><span class="line"><span class="built_in">console</span>.log(res1(<span class="string">"male"</span>));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"=========================="</span>)</span><br><span class="line"><span class="keyword">var</span> res2 = source.bind(destination);</span><br><span class="line"><span class="built_in">console</span>.log(res2(<span class="number">18</span>,<span class="string">"male"</span>));</span><br></pre></td></tr></table></figure>
<p>打印效果如下：</p>
<p><img src="/2019/02/26/JavaScript进阶之模拟call和apply/image-20190224201114865.png" alt="image-20190224201114865"></p>
<p>我们发现<code>bind</code>函数跟<code>apply</code>和<code>call</code>有两个区别：</p>
<blockquote>
<p>1.bind返回的是函数，虽然也有call和apply的作用，但是需要在调用bind()时生效</p>
<p>2.bind中也可以添加参数</p>
</blockquote>
<p>明白了区别，下面我们来模拟<code>bind</code>函数。</p>
<h2 id="模拟Function-prototype-bind"><a href="#模拟Function-prototype-bind" class="headerlink" title="模拟Function.prototype.bind()"></a>模拟Function.prototype.bind()</h2><p>和模拟call一样，现摘抄下面的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">source</span>(<span class="params">age,gender</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.name);</span><br><span class="line">    <span class="built_in">console</span>.log(age);</span><br><span class="line">    <span class="built_in">console</span>.log(gender);</span><br><span class="line">    <span class="comment">//添加一个返回值对象</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        age:age,</span><br><span class="line">        gender:gender,</span><br><span class="line">        name:<span class="keyword">this</span>.name</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> destination = &#123;</span><br><span class="line">    name:<span class="string">"xuan"</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>然后我们定义一个函数<code>bind1</code>，如果执行下面的代码能够返回和<code>bind</code>函数一样的值，就达到我们的目的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> res = source.bind1(destination,<span class="number">18</span>);</span><br><span class="line"><span class="built_in">console</span>.log(res(<span class="string">"male"</span>));</span><br></pre></td></tr></table></figure>
<p>首先我们定义一个bind1函数，因为返回值是一个函数，所以我们可以这么写：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span>.prototype.bind1 = <span class="function"><span class="keyword">function</span>(<span class="params">ctx,...args</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> that = <span class="keyword">this</span>;<span class="comment">//外层的this指向通过变量传进去</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">//将外层函数的参数和内层函数的参数合并</span></span><br><span class="line">        <span class="keyword">var</span> all_args = [...args].concat([...arguments]);</span><br><span class="line">        <span class="comment">//因为ctx是外层的this指针，在外层我们使用一个变量that引用进来</span></span><br><span class="line">        <span class="keyword">return</span> that.apply(ctx,all_args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>打印效果如下：</p>
<p><img src="/2019/02/26/JavaScript进阶之模拟call和apply/image-20190225230039054.png" alt="image-20190225230039054"></p>
<p>这里我们利用闭包，把外层函数的<code>ctx</code>和参数<code>args</code>传到内层函数，再将<strong>内外传递的参数合并</strong>，然后使用<code>apply()</code>或<code>call()</code>函数，将其返回。</p>
<p>当我们调用<code>res(&quot;male&quot;)</code>时，因为外层<code>ctx</code>和<code>args</code>还是会存在内存当中，所以调用时，前面的<code>ctx</code>也就是<code>source</code>，<code>args</code>也就是18，再将传入的”male”跟18合并[18,’male’]，执行<code>source.apply(destination,[18,&#39;male&#39;]);</code>返回函数结果即可。<code>bind()</code>的模拟完成！</p>
<p>但是<code>bind</code>除了上述用法，还可以有如下用法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">source</span>(<span class="params">age,gender</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.name);</span><br><span class="line">    <span class="built_in">console</span>.log(age);</span><br><span class="line">    <span class="built_in">console</span>.log(gender);</span><br><span class="line">    <span class="comment">//添加一个返回值对象</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        age:age,</span><br><span class="line">        gender:gender,</span><br><span class="line">        name:<span class="keyword">this</span>.name</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> destination = &#123;</span><br><span class="line">    name:<span class="string">"xuan"</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> res = source.bind1(destination,<span class="number">18</span>);</span><br><span class="line"><span class="keyword">var</span> person = <span class="keyword">new</span> res(<span class="string">"male"</span>);</span><br><span class="line"><span class="built_in">console</span>.log(person);</span><br></pre></td></tr></table></figure>
<p>打印效果如下：</p>
<p><img src="/2019/02/26/JavaScript进阶之模拟call和apply/image-20190225230707230.png" alt="image-20190225230707230"></p>
<p>我们发现<code>bind</code>函数支持<code>new</code>关键字，调用的时候<code>this</code>的绑定失效了，那么<code>new</code>之后，<code>this</code>指向哪里呢？我们来试一下，代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">source</span>(<span class="params">age,gender</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> destination = &#123;</span><br><span class="line">    name:<span class="string">"xuan"</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> res = source.bind(destination,<span class="number">18</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">new</span> res(<span class="string">"male"</span>));</span><br><span class="line"><span class="built_in">console</span>.log(res(<span class="string">"male"</span>));</span><br></pre></td></tr></table></figure>
<p><img src="/2019/02/26/JavaScript进阶之模拟call和apply/image-20190225232709714.png" alt="image-20190225232709714"></p>
<p>执行<code>new</code>的时候，我们发现虽然<code>bind</code>的第一个参数是<code>destination</code>，但是<code>this</code>是指向<code>source</code>的。</p>
<p><img src="/2019/02/26/JavaScript进阶之模拟call和apply/image-20190225232842678.png" alt="image-20190225232842678"></p>
<p>不用<code>new</code>的话，<code>this</code>指向<code>destination</code>。</p>
<p>好，现在再来回顾一下我们的<code>bind1</code>实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span>.prototype.bind1 = <span class="function"><span class="keyword">function</span>(<span class="params">ctx,...args</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> that = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">//将外层函数的参数和内层函数的参数合并</span></span><br><span class="line">        <span class="keyword">var</span> all_args = [...args].concat([...arguments]);</span><br><span class="line">        <span class="comment">//因为ctx是外层的this指针，在外层我们使用一个变量that引用进来</span></span><br><span class="line">        <span class="keyword">return</span> that.apply(ctx,all_args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果我们使用：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> res = source.bind(destination,<span class="number">18</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">new</span> res(<span class="string">"male"</span>));</span><br></pre></td></tr></table></figure>
<p>如果执行上述代码，我们的<code>ctx</code>还是<code>destination</code>，也就是说这个时候下面的<code>source</code>函数中的<code>ctx</code>还是指向<code>destination</code>。而根据<code>Function.prototype.bind</code>的用法，这时<code>this</code>应该是指向<code>source</code>自身。</p>
<p>我们先把部分代码抄下来：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">source</span>(<span class="params">age,gender</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.name);</span><br><span class="line">    <span class="built_in">console</span>.log(age);</span><br><span class="line">    <span class="built_in">console</span>.log(gender);</span><br><span class="line">    <span class="comment">//添加一个返回值对象</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        age:age,</span><br><span class="line">        gender:gender,</span><br><span class="line">        name:<span class="keyword">this</span>.name</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> destination = &#123;</span><br><span class="line">    name:<span class="string">"xuan"</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>我们改一下bind1函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span>.prototype.bind1 = <span class="function"><span class="keyword">function</span> (<span class="params">ctx, ...args</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> that = <span class="keyword">this</span>;<span class="comment">//that肯定是source</span></span><br><span class="line">    <span class="comment">//定义了一个函数</span></span><br><span class="line">    <span class="keyword">let</span> f = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">//将外层函数的参数和内层函数的参数合并</span></span><br><span class="line">        <span class="keyword">var</span> all_args = [...args].concat([...arguments]);</span><br><span class="line">        <span class="comment">//因为ctx是外层的this指针，在外层我们使用一个变量that引用进来</span></span><br><span class="line">        <span class="keyword">var</span> real_ctx = <span class="keyword">this</span> <span class="keyword">instanceof</span> f ? <span class="keyword">this</span> : ctx;</span><br><span class="line">        <span class="keyword">return</span> that.apply(real_ctx, all_args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//函数的原型指向source的原型，这样执行new f()的时候this就会通过原型链指向source</span></span><br><span class="line">    f.prototype = <span class="keyword">this</span>.prototype;</span><br><span class="line">    <span class="comment">//返回函数</span></span><br><span class="line">    <span class="keyword">return</span> f;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们执行</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> res = source.bind1(destination,<span class="number">18</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">new</span> res(<span class="string">"male"</span>));</span><br></pre></td></tr></table></figure>
<p>效果如下：</p>
<p><img src="/2019/02/26/JavaScript进阶之模拟call和apply/image-20190225235357902.png" alt="image-20190225235357902"></p>
<p>已经达到我们的效果！</p>
<p>现在分析一下上述实现的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//调用var res = source.bind1(destination,18)时的代码分析</span></span><br><span class="line"><span class="built_in">Function</span>.prototype.bind1 = <span class="function"><span class="keyword">function</span> (<span class="params">ctx, ...args</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> that = <span class="keyword">this</span>;<span class="comment">//that肯定是source</span></span><br><span class="line">    <span class="comment">//定义了一个函数</span></span><br><span class="line">    <span class="keyword">let</span> f = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">       ... <span class="comment">//内部先不管</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//函数的原型指向source的原型，这样执行new f()的时候this就会指向一个新家的对象，这个对象通过原型链指向source，这正是我们上面执行apply的时候需要传入的参数</span></span><br><span class="line">     <span class="comment">//f.prototype==&gt;source.prototype</span></span><br><span class="line">    f.prototype = <span class="keyword">this</span>.prototype;</span><br><span class="line">    <span class="comment">//返回函数</span></span><br><span class="line">    <span class="keyword">return</span> f;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>f()函数的内部实现分析：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//new res("male")相当于运行new f("male")；下面进行函数的运行态分析</span></span><br><span class="line"><span class="keyword">let</span> f = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="keyword">this</span>);<span class="comment">//这个时候打印this就是一个_proto_指向f.prototype的对象,因为f.prototype==&gt;source.prototype，所以this._proto_==&gt;source.prototype</span></span><br><span class="line">     <span class="comment">//将外层函数的参数和内层函数的参数合并</span></span><br><span class="line">     <span class="keyword">var</span> all_args = [...args].concat([...arguments]);</span><br><span class="line">     <span class="comment">//正常不用new的时候this指向当前调用处的this指针(在全局环境中执行，this就是window对象)；使用new的话这个this对象的原型链上有一个类型是f的原型对象。</span></span><br><span class="line">    <span class="comment">//那么判断一下，如果this instanceof f，那么real_ctx=this,否则real_ctx=ctx;</span></span><br><span class="line">     <span class="keyword">var</span> real_ctx = <span class="keyword">this</span> <span class="keyword">instanceof</span> f ? <span class="keyword">this</span> : ctx;</span><br><span class="line">    <span class="comment">//现在把真正分配给source函数的对象传入</span></span><br><span class="line">     <span class="keyword">return</span> that.apply(real_ctx, all_args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此<code>bind()</code>函数的模拟实现完毕！如有不对之处，欢迎拍砖！您的宝贵意见是我写作的动力，谢谢大家。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhehuaxuan.github.io/2019/02/21/JavaScript新建对象的模拟/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZheHuaXuan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhehua's note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/21/JavaScript新建对象的模拟/" itemprop="url">JavaScript进阶之模拟new Object()过程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-21T22:54:49+08:00">
                2019-02-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript进阶系列/" itemprop="url" rel="index">
                    <span itemprop="name">JavaScript进阶系列</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="写在前面的话"><a href="#写在前面的话" class="headerlink" title="写在前面的话"></a>写在前面的话</h2><p>前端的入门相对简单，相对于其他方向天花板可能会相对较低。但是在市场上一个优秀的前端依旧是很抢手的。能够站在金字塔上的人往往寥寥无几。</p>
<p>目前前端也已经一年半了，在公司的知识栈相对落后，就业形势不容乐观，所以有必要自己琢磨，往中高级前端进阶。后续我将推出《JavaScript进阶系列》，一方面是一个监督自己学习的一个过程，另一方面也会给看到的童鞋一些启发。</p>
<h2 id="JavaScript新建对象的过程"><a href="#JavaScript新建对象的过程" class="headerlink" title="JavaScript新建对象的过程"></a>JavaScript新建对象的过程</h2><p>在ES5中定义一个函数来创建对象，如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params">name</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">&#125;</span><br><span class="line">Person.prototype.getName = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> name;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> person = <span class="keyword">new</span> Person(<span class="string">"xuan"</span>);</span><br><span class="line"><span class="built_in">console</span>.log(person.name);<span class="comment">//输出：xuan</span></span><br><span class="line"><span class="built_in">console</span>.log(person.getName());<span class="comment">//输出：xuan</span></span><br></pre></td></tr></table></figure>
<p>我们看到当我们新建一个对象，我们就可以访问构造器中的指向<strong>this</strong>的属性，还可以访问原型中的属性。我们不妨把JavaScript调用<strong>new</strong>的过程主要由下面四步组成：</p>
<blockquote>
<ol>
<li>新生成一个空对象</li>
<li>将空对象链接到原型中</li>
<li>绑定this</li>
<li>返回新对象</li>
</ol>
</blockquote>
<p>下面跟着我按照这个思路来创建对象：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">create</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">//Todo</span></span><br><span class="line">&#125;</span><br><span class="line">person = create(Person,<span class="string">"xuan"</span>);<span class="comment">//create(ObjectName,...arguments)</span></span><br></pre></td></tr></table></figure>
<p>我们使用如上所示的函数来模拟<strong>new</strong>关键字。</p>
<p>首先第一步新建一个对象：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">create</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> obj = <span class="keyword">new</span> <span class="built_in">Object</span>();</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line">person = create(Person,<span class="string">"xuan"</span>);</span><br></pre></td></tr></table></figure>
<p>现在已经创建并返回一个对象，当然现在打印出来肯定是一个普通的对象，毕竟流程还没有走完，我们接着往下看。</p>
<p>第二步链接到原型中：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">create</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> obj = <span class="keyword">new</span> <span class="built_in">Object</span>();</span><br><span class="line">    <span class="keyword">var</span> <span class="keyword">constructor</span> = [].shift.call(arguments);</span><br><span class="line">    console.log(<span class="keyword">constructor</span>);</span><br><span class="line">    console.log(arguments);</span><br><span class="line">    obj.__proto__ = <span class="keyword">constructor</span>.prototype;</span><br><span class="line">    return obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">person = create(Person,"xuan");</span><br></pre></td></tr></table></figure>
<p><img src="/2019/02/21/JavaScript新建对象的模拟/image-20190221235358202.png" alt="image-20190221235358202"></p>
<p>现在把构造函数和参数都打印出来了。没问题！</p>
<p>第三步绑定this，如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">create</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> obj = <span class="keyword">new</span> <span class="built_in">Object</span>();</span><br><span class="line">  <span class="keyword">let</span> <span class="keyword">constructor</span> = [].shift.call(arguments)</span><br><span class="line">  obj.__proto__ = <span class="keyword">constructor</span>.prototype</span><br><span class="line">  <span class="keyword">constructor</span>.apply(obj, arguments);</span><br><span class="line">  console.log(obj);  </span><br><span class="line">  return obj;</span><br><span class="line">&#125;</span><br><span class="line">person = create(Person,"xuan");</span><br></pre></td></tr></table></figure>
<p><img src="/2019/02/21/JavaScript新建对象的模拟/image-20190222002407145.png" alt="image-20190222002407145"></p>
<p>打印结果实现new对象的效果。</p>
<p>现在改一下构造函数代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params">name</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        name:<span class="string">"abc"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> person = <span class="keyword">new</span> Person(<span class="string">"xuan"</span>);</span><br><span class="line"><span class="built_in">console</span>.log(person);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.prototype.toString.call(person));</span><br></pre></td></tr></table></figure>
<p>效果如下:</p>
<p><img src="/2019/02/21/JavaScript新建对象的模拟/image-20190222002825742.png" alt="image-20190222002825742"></p>
<p>我们执行一下我们构建的函数效果如下：</p>
<p><img src="/2019/02/21/JavaScript新建对象的模拟/image-20190222002932127.png" alt="image-20190222002932127"></p>
<p>发现不一致，所以我们要处理第三步绑定this中apply函数的返回值：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">create</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> obj = <span class="keyword">new</span> <span class="built_in">Object</span>();</span><br><span class="line">  <span class="keyword">let</span> <span class="keyword">constructor</span> = [].shift.call(arguments)</span><br><span class="line">  obj.__proto__ = <span class="keyword">constructor</span>.prototype</span><br><span class="line">  //<span class="keyword">constructor</span>.apply(obj, arguments);</span><br><span class="line">  let res = <span class="keyword">constructor</span>.apply(obj, arguments);</span><br><span class="line">  if(res)&#123;</span><br><span class="line">     <span class="keyword">return</span> res;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">     <span class="keyword">return</span> obj;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">person = create(Person,<span class="string">"xuan"</span>);</span><br></pre></td></tr></table></figure>
<p>效果如下：</p>
<p><img src="/2019/02/21/JavaScript新建对象的模拟/image-20190222003313618.png" alt="image-20190222003313618"></p>
<p>完美！</p>
<p>现在我们思考一下这里的res返回值有三种情况：undefined，基本类型，对象。</p>
<blockquote>
<p>如果res是undefined时，返回obj；</p>
<p>如果res是基本类型我们也返回obj；</p>
<p>如果res是对象我们返回res对象；</p>
</blockquote>
<p>综合一下：</p>
<p>如果返回的res对象是Object类型那么返回res，否则返回obj。当然其他的判断条件也是可以的。最后代码优化如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">create</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> obj = <span class="keyword">new</span> <span class="built_in">Object</span>();</span><br><span class="line">  <span class="keyword">let</span> <span class="keyword">constructor</span> = [].shift.call(arguments)</span><br><span class="line">  obj.__proto__ = <span class="keyword">constructor</span>.prototype</span><br><span class="line">  //<span class="keyword">constructor</span>.apply(obj, arguments);</span><br><span class="line">  let res = <span class="keyword">constructor</span>.apply(obj, arguments);</span><br><span class="line">  return res instanceof Object?res:obj;</span><br><span class="line">&#125;</span><br><span class="line">person = create(Person,"xuan");</span><br></pre></td></tr></table></figure>
<h2 id="几个问题"><a href="#几个问题" class="headerlink" title="几个问题"></a>几个问题</h2><p>现在的代码已经完美了么？我们先来提几个问题。</p>
<blockquote>
<ol>
<li>new Object()创建的对象纯净么？</li>
<li>为啥使用[].shift.call()来进行参数分割？arguments是一个数组么？</li>
</ol>
</blockquote>
<h3 id="new-Object-创建的对象纯净么？"><a href="#new-Object-创建的对象纯净么？" class="headerlink" title="new Object()创建的对象纯净么？"></a>new Object()创建的对象纯净么？</h3><p>首先什么是纯净？我们定义一个对象的<code>__proto__</code>属性为空的对象是一个纯净的对象。</p>
<p>在第二步的时候中已经改变的obj的原型链，所以无论它前面的原型链是咋样的都无所谓，但是为了保证对象的纯净性，我们有必要引出<code>Object.create()</code>，该方法创建一个新对象，使用现有的对象来提供新创建的对象的<code>__proto__</code>。我们来看一下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> person1 = <span class="built_in">Object</span>.create(&#123;&#125;);</span><br></pre></td></tr></table></figure>
<p>打印如下:</p>
<p><img src="/2019/02/21/JavaScript新建对象的模拟/image-20190222192124090.png" alt="image-20190222192124090"></p>
<p>我们看到person1的<code>__proto__</code>指向了<code>{}</code>对象，所以我们在上述代码中直接修改如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">create</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="keyword">constructor</span> = [].shift.call(arguments);</span><br><span class="line">  let obj = Object.create(<span class="keyword">constructor</span>.prototype);</span><br><span class="line">  let res = <span class="keyword">constructor</span>.apply(obj, arguments);</span><br><span class="line">  return res instanceof Object?res:obj;</span><br><span class="line">&#125;</span><br><span class="line">person = create(Person,"xuan");</span><br></pre></td></tr></table></figure>
<h3 id="为啥使用-shift-call-来进行参数分割？arguments是一个数组么？"><a href="#为啥使用-shift-call-来进行参数分割？arguments是一个数组么？" class="headerlink" title="为啥使用[].shift.call()来进行参数分割？arguments是一个数组么？"></a>为啥使用[].shift.call()来进行参数分割？arguments是一个数组么？</h3><p>首先我们知道arguments是函数传入的参数，那么这个参数是数组么？我们打印一下便知：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="built_in">arguments</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.prototype.toString.call(<span class="built_in">arguments</span>));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">arguments</span> <span class="keyword">instanceof</span> <span class="built_in">Array</span>);</span><br></pre></td></tr></table></figure>
<p>结果如下</p>
<p><img src="/2019/02/21/JavaScript新建对象的模拟/image-20190222193001990.png" alt="image-20190222193001990"></p>
<p>不是数组。我们展开发现他跟数组很像，查一下资料发现这个对象是<strong>类数组</strong>。里面没有shift函数，直接调用shift会报错。我们使用使用Array.from(arguments)将arguments转成数组，然后在调用shift函数也是一种思路。但是在这里我们使用apply最适合。所以下述代码是模拟new Object()的最优代码:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">create</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="keyword">constructor</span> = [].shift.call(arguments);</span><br><span class="line">  let obj = Object.create(<span class="keyword">constructor</span>.prototype);</span><br><span class="line">  let res = <span class="keyword">constructor</span>.apply(obj, arguments);</span><br><span class="line">  return res instanceof Object?res:obj;</span><br><span class="line">&#125;</span><br><span class="line">person = create(Person,"xuan");</span><br></pre></td></tr></table></figure>
<p>还有更优的实现方法，请大佬们不吝拍砖！</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhehuaxuan.github.io/2019/02/20/手写MVVM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZheHuaXuan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhehua's note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/20/手写MVVM/" itemprop="url">模拟Vue的MVVM</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-20T20:37:22+08:00">
                2019-02-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Vue/" itemprop="url" rel="index">
                    <span itemprop="name">Vue</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>为了真正的了解MVVM的核心思想，本文以Vue框架为切入点，手写模拟实现Vue框架的双向数据绑定，本文适合想进一步了解Vue底层的同学，当然对于想彻底搞懂MVVM原理的同学也会有所启发。</p>
<h2 id="MVVM概念"><a href="#MVVM概念" class="headerlink" title="MVVM概念"></a>MVVM概念</h2><p><img src="https://user-images.githubusercontent.com/14359831/53066571-76780400-350b-11e9-8314-d3ac5785e910.png" alt="image"></p>
<p>MVVM的概念可以参考很多文章，比如<a href="http://www.ruanyifeng.com/blog/2015/02/mvcmvp_mvvm.html" target="_blank" rel="noopener">这篇</a>，其最核心的就是实现<strong>视图</strong>和<strong>视图模型</strong>的双向绑定。本文主要探究MVVM在Vue中的实现，下面将会围绕这个主题进行展开。</p>
<h2 id="Object-defineProperty"><a href="#Object-defineProperty" class="headerlink" title="Object.defineProperty()"></a>Object.defineProperty()</h2><p>在讲解Vue的双向绑定之前，先来回顾一下Object.defineProperty()，在<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty" target="_blank" rel="noopener">MDN</a>中也有详细的解释，已经知道的同学可以跳过这个章，没看过的同学建议往下看。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;&#125;;    </span><br><span class="line">person.name = <span class="string">"xuan"</span>;</span><br><span class="line"><span class="built_in">console</span>.log(person);</span><br></pre></td></tr></table></figure>
<p>上述代码在我们的日常开发中司空见惯，打印结果如下：</p>
<p><img src="https://user-images.githubusercontent.com/14359831/53067188-146cce00-350e-11e9-9de9-8411981353c7.png" alt="image"></p>
<p>现在我们改写一下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;&#125;;</span><br><span class="line"><span class="built_in">Object</span>.defineProperty(person,</span><br><span class="line">	<span class="string">"name"</span>,</span><br><span class="line">    &#123;</span><br><span class="line">    	value:<span class="string">"xuan"</span> </span><br><span class="line">	&#125;</span><br><span class="line">);</span><br><span class="line"><span class="built_in">console</span>.log(person);</span><br></pre></td></tr></table></figure>
<p>在IE8以上浏览器中打印结果如下：</p>
<p><img src="https://user-images.githubusercontent.com/14359831/53067251-63b2fe80-350e-11e9-9cad-9c948a42c573.png" alt="image"></p>
<p>一点问题没有。下面我们改一下这个对象属性，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;&#125;;</span><br><span class="line"><span class="built_in">Object</span>.defineProperty(person,</span><br><span class="line">     <span class="string">"name"</span>,</span><br><span class="line">	&#123;</span><br><span class="line">    	value:<span class="string">"xuan"</span></span><br><span class="line">	&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(person);</span><br><span class="line">person.name = <span class="string">"xue"</span>;</span><br><span class="line"><span class="built_in">console</span>.log(person);</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<p><img src="https://user-images.githubusercontent.com/14359831/53067332-b987a680-350e-11e9-9bb7-217c73fa6021.png" alt="image"></p>
<p>我们发现结果没有变化，直接使用”对象.属性”的方法已经失效，查一下API，在代码中添加writable属性</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;&#125;;</span><br><span class="line"><span class="built_in">Object</span>.defineProperty(person,</span><br><span class="line">	<span class="string">"name"</span>,</span><br><span class="line">	&#123;</span><br><span class="line">		value:<span class="string">"xuan"</span>,</span><br><span class="line">        writable:<span class="literal">true</span></span><br><span class="line">     &#125;);</span><br><span class="line">     <span class="built_in">console</span>.log(person);</span><br><span class="line">     person.name = <span class="string">"xue"</span>;</span><br><span class="line">     <span class="built_in">console</span>.log(person);</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<p><img src="https://user-images.githubusercontent.com/14359831/53067431-1daa6a80-350f-11e9-877f-2ad6a79cb2f2.png" alt="image"></p>
<p>现在已经可以修改对象属性了，所以<strong>writable属性就是可复写的</strong>。在API中还存在<strong>configurable</strong>和<strong>enumerable</strong>属性，MDN这么说的：</p>
<blockquote>
<p><em><em>configurable</em></em>  </p>
<p>当且仅当该属性的 configurable 为 true 时，该属性描述符才能够被改变，同时该属性也能从对应的对象上被删除。</p>
<p><em><em>enumerable</em></em></p>
<p> 当且仅当该属性的enumerable为true时，该属性才能够出现在对象的枚举属性中。默认为 false。</p>
</blockquote>
<p> 如果觉得不明白，看下面这段代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;&#125;; </span><br><span class="line"><span class="built_in">Object</span>.defineProperty(person,</span><br><span class="line">	<span class="string">"name"</span>,</span><br><span class="line">	&#123;</span><br><span class="line">    	value:<span class="string">"xuan"</span>,</span><br><span class="line">		writable:<span class="literal">true</span>,</span><br><span class="line">    	configurable:<span class="literal">true</span>,</span><br><span class="line">    	enumerable:<span class="literal">true</span></span><br><span class="line">	&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(person);</span><br><span class="line"><span class="keyword">delete</span> person.name;</span><br><span class="line"><span class="built_in">console</span>.log(person);</span><br><span class="line">person.name = <span class="string">"xuan"</span>;</span><br><span class="line">person.age = <span class="number">18</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> key <span class="keyword">in</span> person)&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果如下:</p>
<p><img src="https://user-images.githubusercontent.com/14359831/53067658-1899eb00-3510-11e9-97b3-417377aad939.png" alt="image"></p>
<p>简而言之：<strong>configurable 就是可删除的，enumerable就是可遍历的</strong>。在API中还有两个配置项set和get，废话不说，直接上代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">var</span> person = &#123;&#125;;</span><br><span class="line"> <span class="built_in">Object</span>.defineProperty(person,</span><br><span class="line"> 		<span class="string">"name"</span>,</span><br><span class="line"> 		&#123;</span><br><span class="line"> 			value: <span class="string">"xuan"</span>,</span><br><span class="line"> 			writable: <span class="literal">true</span>,</span><br><span class="line"> 			configurable: <span class="literal">true</span>,</span><br><span class="line">            enumerable: <span class="literal">true</span>,</span><br><span class="line">            set: <span class="function"><span class="keyword">function</span> (<span class="params">newVal</span>) </span>&#123;</span><br><span class="line">            	<span class="built_in">console</span>.log(<span class="string">`此处设置一个新值:<span class="subst">$&#123;newVal&#125;</span>`</span>)</span><br><span class="line">            	<span class="keyword">this</span>.value = newVal;</span><br><span class="line">            	&#125;,</span><br><span class="line">            get: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            	<span class="built_in">console</span>.log(<span class="string">`此处获取一个值:<span class="subst">$&#123;<span class="keyword">this</span>.value&#125;</span>`</span>)</span><br><span class="line">            	<span class="keyword">return</span> <span class="keyword">this</span>.value;</span><br><span class="line">            	&#125;</span><br><span class="line">            &#125;);</span><br><span class="line"><span class="built_in">console</span>.log(person);</span><br></pre></td></tr></table></figure>
<p>结果报错</p>
<p><img src="https://user-images.githubusercontent.com/14359831/53078096-69204100-352e-11e9-8062-88ed4b2bc806.png" alt="image"></p>
<p>上述错误的意思是我们要把writable和value配置项去掉。为什么？get和set方法是获取和设置值的函数，有了它们就不需要writable和value配置项了。如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;&#125;;</span><br><span class="line"><span class="built_in">Object</span>.defineProperty(person,</span><br><span class="line">       <span class="string">"name"</span>,</span><br><span class="line">       &#123;</span><br><span class="line">    		configurable: <span class="literal">true</span>,</span><br><span class="line">    		enumerable: <span class="literal">true</span>,</span><br><span class="line">    		set: <span class="function"><span class="keyword">function</span> (<span class="params">newVal</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">`此处设置一个新值:<span class="subst">$&#123;newVal&#125;</span>`</span>)</span><br><span class="line">                <span class="keyword">this</span>.value = newVal;</span><br><span class="line">            &#125;,</span><br><span class="line">    		get: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">`此处获取一个值:<span class="subst">$&#123;<span class="keyword">this</span>.value&#125;</span>`</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.value;</span><br><span class="line">            &#125;</span><br><span class="line">		&#125;);</span><br><span class="line">person.name = <span class="string">"xuan"</span>;</span><br><span class="line"><span class="built_in">console</span>.log(person);</span><br><span class="line"><span class="built_in">console</span>.log(person.name);</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<p><img src="https://user-images.githubusercontent.com/14359831/53078543-65d98500-352f-11e9-9610-c19fbb9badde.png" alt="image"></p>
<p>在设置和获取这个对象的属性时，都会打印相应的信息。一旦对象的信息有所修改，我们都能第一时间发现它，这就是<strong><em>\</em>数据劫持**</strong>。当对象的值改变的时候，如果我们能够自动去更新对应的视图，就能够完成从<strong><em>\</em>对象视图模型（VM）=&gt;视图**</strong>的单向数据流绑定。</p>
<h2 id="模拟Vue的数据劫持"><a href="#模拟Vue的数据劫持" class="headerlink" title="模拟Vue的数据劫持"></a>模拟Vue的数据劫持</h2><p>在讲解数据劫持之前，先来看下面一段代码</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">p</span>&gt;</span>姓名：&#123;name&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> vue = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">		el:<span class="string">"#app"</span>,</span><br><span class="line">		data:&#123;</span><br><span class="line">			name:<span class="string">"xuan"</span></span><br><span class="line">			&#125; </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这是一个最最基本的Vue程序，但是我们没有导入Vue的库，现在我们来看界面的效果：</p>
<p><img src="https://user-images.githubusercontent.com/14359831/53079277-0b412880-3531-11e9-8577-cba5b71780ff.png" alt="image"></p>
<p>现在我们没有看到任何效果，控制台还输出错误。好，我们现在只是搭建了一个空壳，下面我们一步步来实现和完善它。</p>
<h3 id="劫持Vue中的data属性中的对象"><a href="#劫持Vue中的data属性中的对象" class="headerlink" title="劫持Vue中的data属性中的对象"></a>劫持Vue中的data属性中的对象</h3><p>  我们先来定义一个Vue类，然后劫持传入配置项的data属性中的对象，代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vue</span>(<span class="params">options=&#123;&#125;</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">this</span>.$options = options;</span><br><span class="line">	<span class="keyword">let</span> obj = <span class="keyword">this</span>._data = options.data;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">let</span> key <span class="keyword">in</span> obj)&#123;</span><br><span class="line">		<span class="keyword">var</span> val = obj[key];</span><br><span class="line">		<span class="built_in">Object</span>.defineProperty(obj,key,&#123;</span><br><span class="line">				configurable:<span class="literal">true</span>,</span><br><span class="line">				enumerable:<span class="literal">true</span>,</span><br><span class="line">				set:<span class="function"><span class="keyword">function</span>(<span class="params">newVal</span>)</span>&#123;</span><br><span class="line">					<span class="keyword">if</span>(newVal ===  val) <span class="keyword">return</span>;</span><br><span class="line">					<span class="built_in">console</span>.log(<span class="string">"数据已更新"</span>)</span><br><span class="line">					val = newVal;</span><br><span class="line">					&#125;,</span><br><span class="line">				get:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">					<span class="built_in">console</span>.log(<span class="string">"数据已获取"</span>)</span><br><span class="line">					<span class="keyword">return</span> val;</span><br><span class="line">					&#125;</span><br><span class="line">		 &#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用<em>$options</em>用于保存Vue的配置参数对象，<em>_data</em>用于存储真正的数据。我们打印下述信息：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(vue);</span><br><span class="line"><span class="built_in">console</span>.log(vue._data.name=<span class="string">"xue"</span>);</span><br><span class="line"><span class="built_in">console</span>.log(vue._data.name)</span><br></pre></td></tr></table></figure>
<p>看一下效果：</p>
<p><img src="https://user-images.githubusercontent.com/14359831/53082677-527ee780-3538-11e9-8066-61064a6a890c.png" alt="image"> </p>
<p>我们需要的效果实现了！我们把代码整理一下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> vue = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">	el: <span class="string">"#app"</span>,</span><br><span class="line">	data: &#123;</span><br><span class="line">		name: <span class="string">"xuan"</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(vue);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vue</span>(<span class="params">options = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">this</span>.$options = options;</span><br><span class="line">	<span class="keyword">let</span> data = <span class="keyword">this</span>._data = options.data;</span><br><span class="line">	observe(data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observe</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">new</span> Observe(data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Observe</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> keys = <span class="built_in">Object</span>.getOwnPropertyNames(data);</span><br><span class="line">	keys.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">		<span class="keyword">var</span> val = data[key];</span><br><span class="line">		<span class="built_in">Object</span>.defineProperty(data, key, &#123;</span><br><span class="line">				enumerable: <span class="literal">true</span>,</span><br><span class="line">				configurable: <span class="literal">false</span>,</span><br><span class="line">				get: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">					<span class="keyword">return</span> val;</span><br><span class="line">				&#125;,</span><br><span class="line">				set: <span class="function"><span class="keyword">function</span> (<span class="params">newVal</span>) </span>&#123;</span><br><span class="line">					<span class="built_in">console</span>.log(<span class="string">'获取数据属性 '</span>, val, <span class="string">' --&gt; '</span>, newVal);</span><br><span class="line">					val = newVal;</span><br><span class="line">				&#125;&#125;);</span><br><span class="line">		&#125;, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们把数据劫持的代码逻辑写在Observe类中，我们下面就是围绕这个展开。</p>
<p>呃…现在我们的效果真达到了么？我们重新设置一下vue对象</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> vue = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">	el: <span class="string">"#app"</span>,</span><br><span class="line">	data: &#123;</span><br><span class="line">		name: <span class="string">"xuan"</span>,</span><br><span class="line">		degree:&#123;</span><br><span class="line">			name:<span class="string">"master"</span>,</span><br><span class="line">			time:<span class="string">"3year"</span></span><br><span class="line">			&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(vue);</span><br></pre></td></tr></table></figure>
<p>结果显示如下</p>
<p><img src="/2019/02/20/手写MVVM/image-20190220220513732.png" alt="image-20190220220513732"></p>
<p>我们发现name属性还是有set和get方法，但是degree对象还嵌套着对象，所以这个时候我们需要递归遍历整个对象。于是添加修改代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Observe</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> data!=<span class="string">"object"</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">var</span> keys = <span class="built_in">Object</span>.getOwnPropertyNames(data);</span><br><span class="line">    keys.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> val = data[key];</span><br><span class="line">        observe(val);</span><br><span class="line">        <span class="built_in">Object</span>.defineProperty(data, key, &#123;</span><br><span class="line">            enumerable: <span class="literal">true</span>,</span><br><span class="line">            configurable: <span class="literal">false</span>,</span><br><span class="line">            get: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">'获取数据属性'</span>,val);</span><br><span class="line">                <span class="keyword">return</span> val;</span><br><span class="line">            &#125;,</span><br><span class="line">            set: <span class="function"><span class="keyword">function</span> (<span class="params">newVal</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">'设置数据属性 '</span>, val, <span class="string">' --&gt; '</span>, newVal);</span><br><span class="line">                val = newVal;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主要修改两个地方，在var val = data[key]后添加observe(val)，对获取的属性值进行观察，然后在设置递归终止条件， if(typeof data!=”object”) return;最后效果如下：</p>
<p><img src="/2019/02/20/手写MVVM/image-20190220220624044.png" alt="image-20190220220624044"></p>
<p>下面再来写一段代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> vue = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    el: <span class="string">"#app"</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">         name: <span class="string">"xuan"</span>,</span><br><span class="line">         degree: &#123;</span><br><span class="line">               name: <span class="string">"master"</span>,</span><br><span class="line">                time: <span class="string">"3year"</span></span><br><span class="line">    	&#125;</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;);</span><br><span class="line">vue._data.name = &#123;<span class="attr">a</span>:<span class="number">1</span>&#125;</span><br><span class="line"><span class="built_in">console</span>.log(vue);</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<p><img src="/2019/02/20/手写MVVM/image-20190220225340987.png" alt="image-20190220225340987"></p>
<p>我们发现name属性其实已经被劫持到了，但是传进去的对象没有被劫持到，所以在set方法里面也需要添加observe函数。如下所示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Observe</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(data==<span class="literal">null</span> || <span class="keyword">typeof</span> data!=<span class="string">"object"</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="built_in">Object</span>.keys(data).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">key</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> val = data[key];</span><br><span class="line">        observe(val);</span><br><span class="line">        <span class="built_in">Object</span>.defineProperty(data, key, &#123;</span><br><span class="line">            enumerable: <span class="literal">true</span>,</span><br><span class="line">            configurable: <span class="literal">false</span>,</span><br><span class="line">            get: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">'获取数据属性'</span>,val);</span><br><span class="line">                <span class="keyword">return</span> val;</span><br><span class="line">            &#125;,</span><br><span class="line">            set: <span class="function"><span class="keyword">function</span> (<span class="params">newVal</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">'设置数据属性 '</span>, val, <span class="string">' --&gt; '</span>, newVal);</span><br><span class="line">                val = newVal;</span><br><span class="line">                observe(val);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<p><img src="/2019/02/20/手写MVVM/image-20190220225646064.png" alt="image-20190220225646064"></p>
<p>上述基本完成了对于配置对象中data属性的<strong>数据劫持</strong>。</p>
<h2 id="数据代理"><a href="#数据代理" class="headerlink" title="数据代理"></a>数据代理</h2><p><strong>## References</strong></p>
<p><a href="https://github.com/livoras/blog/issues/11" target="_blank" rel="noopener">界面之下：还原真实的MV*模式</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhehuaxuan.github.io/2018/12/26/js/gc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZheHuaXuan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhehua's note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/26/js/gc/" itemprop="url">JS的GC整理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-26T16:43:23+08:00">
                2018-12-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JAVASCRIPT/" itemprop="url" rel="index">
                    <span itemprop="name">JAVASCRIPT</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="内存泄露"><a href="#内存泄露" class="headerlink" title="内存泄露"></a>内存泄露</h3><h4 id="什么是内存泄露？"><a href="#什么是内存泄露？" class="headerlink" title="什么是内存泄露？"></a>什么是内存泄露？</h4><p>内存泄露就是应用程序不再需要占用内存的时候，由于某些原因，内存没有被操作系统或可用内存池回收。这句话对于所有需要GC的语言都适用，当然包括JS。</p>
<p>JS的内存回收方法主要就是“标记清除”和“引用计数”。</p>
<h4 id="如何判断内存泄露？"><a href="#如何判断内存泄露？" class="headerlink" title="如何判断内存泄露？"></a>如何判断内存泄露？</h4><p><a href="http://www.ruanyifeng.com/blog/2017/04/memory-leak.html" target="_blank" rel="noopener">经验法</a>则是，如果连续五次垃圾回收之后，内存占用一次比一次大，就有内存泄漏。这就要求实时查看内存占用。</p>
<p>查看内存可以使用chrome浏览器中的开发者工具，Performance页签可以进行内存快照的监控。</p>
<h4 id="内存泄露的一般场景是什么？"><a href="#内存泄露的一般场景是什么？" class="headerlink" title="内存泄露的一般场景是什么？"></a>内存泄露的一般场景是什么？</h4><p>1 意外的全局变量</p>
<p>2 被遗忘的计时器或<strong>回调函数</strong></p>
<p>3 脱离 DOM 的引用</p>
<p>4 <strong>闭包</strong></p>
<h4 id="WeakSet-和-WeakMap"><a href="#WeakSet-和-WeakMap" class="headerlink" title="WeakSet 和 WeakMap"></a>WeakSet 和 WeakMap</h4><p>WeakSet 和 WeakMap就是弱引用，在java中也存在这个概念，就是该数据结构不会影响引用变量的计数次数。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhehuaxuan.github.io/2018/09/10/algo/算法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZheHuaXuan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhehua's note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/10/algo/算法/" itemprop="url">算法的目标</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-10T21:29:13+08:00">
                2018-09-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/算法/" itemprop="url" rel="index">
                    <span itemprop="name">算法</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h3><p>1.对遇到的特殊问题要能够自己设计出算法实现；</p>
<p>2.对于原理公开的知名算法，要能将算法原理翻译成具体的算法代码；</p>
<p>3.对已有具体实现的算法，要能够设计出合适的数学模型，将算法应用到实际问题中；</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhehuaxuan.github.io/2018/07/10/js/difficulty/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZheHuaXuan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhehua's note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/10/js/difficulty/" itemprop="url">Javascript原生释疑</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-10T16:43:23+08:00">
                2018-07-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JAVASCRIPT/" itemprop="url" rel="index">
                    <span itemprop="name">JAVASCRIPT</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="1-ES基础知识"><a href="#1-ES基础知识" class="headerlink" title="1.ES基础知识"></a>1.ES基础知识</h4><ol>
<li><p>JS的基本数据类型</p>
<ul>
<li><p>Boolean</p>
</li>
<li><p>String</p>
</li>
<li><p>Number</p>
</li>
<li><p>Null</p>
</li>
<li><p>Undefined</p>
</li>
<li><p>Symbol(ES6)</p>
<blockquote>
<p>注：原始类型不包含Object</p>
</blockquote>
<p><strong>typeof</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typeof</span> xxx;</span><br><span class="line"><span class="comment">//返回：undefined boolean number string object function、symbol 只比基本类型多了object和function</span></span><br><span class="line"><span class="comment">//注意点：</span></span><br><span class="line"><span class="comment">//1.typeof null结果是object  </span></span><br><span class="line"><span class="comment">//2.typeof [1, 2]结果是object typeof 没有array类型  引用类型只有function和object</span></span><br><span class="line"><span class="comment">//3.typeof Symbol() 用typeof获取symbol类型的值得到的是symbo</span></span><br></pre></td></tr></table></figure>
<p><strong>instanceof</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xxx <span class="keyword">instanceof</span> <span class="built_in">Array</span> <span class="comment">//true or false</span></span><br></pre></td></tr></table></figure>
<p>instanceof和typeof的细节，可以移步<a href="http://localhost:4000/2018/06/06/js/js_pro/" target="_blank" rel="noopener">这里</a></p>
</li>
</ul>
</li>
</ol>
<h4 id="1-offsetWidth、clientWidth、scrollWidth、width的区别"><a href="#1-offsetWidth、clientWidth、scrollWidth、width的区别" class="headerlink" title="1. offsetWidth、clientWidth、scrollWidth、width的区别"></a>1. offsetWidth、clientWidth、scrollWidth、width的区别</h4><table>
<thead>
<tr>
<th>属性值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>offsetWidth</td>
<td>真实的width+padding+border</td>
</tr>
<tr>
<td>clientWidth</td>
<td>真实的width+padding</td>
</tr>
<tr>
<td>style.width</td>
<td>返回DOM真实的width</td>
</tr>
<tr>
<td>scrollWidth</td>
<td>返回元素的宽度（包括元素宽度、内边距和溢出尺寸，不包括边框和外边距），无溢出的情况，与clientWidth相同</td>
</tr>
</tbody>
</table>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.gif"
                alt="ZheHuaXuan" />
            
              <p class="site-author-name" itemprop="name">ZheHuaXuan</p>
              <p class="site-description motion-element" itemprop="description">知足.感恩.幸运</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">30</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">43</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/zhehuaxuan" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:xuanzhehua@huawei.com" target="_blank" title="E-Mail">
                    
                      <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ZheHuaXuan</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 个人专属</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
